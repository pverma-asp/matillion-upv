{"job":{"components":{"2961036":{"id":2961036,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-314,"y":-65,"width":32,"height":32,"inputConnectorIDs":[2961035],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2961032],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"parse user custom json fields"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists prod_zendesk.zendesk_user_custom_fields;\ncreate table prod_zendesk.zendesk_user_custom_fields as \nwith tmp as (\n    select id as user_id,\n          user_fields\n    from prod_zendesk.zendesk_users\n    where user_fields is not null \n    )  \n                                                                                                                                                                                                                                                                                                                                 \n    , tmp1 as (\n      select user_id,\n          replace(replace(replace(user_fields, '{', ''), '}', ''), '\"', '') as user_fields\n      from tmp)\n    \n    , numbers as (\n      select 1 as n union all\n      select 2 union all\n      select 3 union all\n      select 4 union all\n      select 5 union all\n      select 6 union all\n      select 7 union all\n      select 8 union all\n      select 9 union all\n      select 10 \n      )     \n    \n    , tmp2  as (\n  select tmp1.user_id\n    ,trim(split_part(split_part(user_fields, ',', n), ': ', 1)) as field_name\n    ,trim(split_part(split_part(user_fields, ',', n), ': ', 2)) as field_value\n  from tmp1\n    cross join numbers\n  where split_part(user_fields, ',', n) is not null\n    and split_part(user_fields, ',' ,n) != '')\n\nselect row_number() over(order by user_id) as zendesk_user_custom_fields_id\n    ,user_id\n    ,field_name\n    ,field_value\nfrom tmp2;  \n    \n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2961037":{"id":2961037,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-448,"y":-64,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2961035],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2961038":{"id":2961038,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-32,"y":-64,"width":32,"height":32,"inputConnectorIDs":[2961033],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"parse ticket custom json field"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists  prod_zendesk.zendesk_ticket_custom_fields;\ncreate table prod_zendesk.zendesk_ticket_custom_fields(\n  zendesk_ticket_custom_fields_id bigint identity(1, 1),\n  ticket_id numeric(20),\n  field_name varchar(100),\n  field_value varchar(100)\n );\n\n  \ninsert into prod_zendesk.zendesk_ticket_custom_fields(ticket_id, field_name, field_value)\nWITH temp as (\n    SELECT id as ticket_id, custom_fields\n    FROM prod_zendesk.zendesk_tickets\n    )\n    \n   ,cte AS (\n    SELECT ticket_id, JSON_EXTRACT_ARRAY_ELEMENT_TEXT(custom_fields, seq.i) AS js\n    FROM temp\n      cross join (select *\n                  from etl.numbers\n                  where i < 50) as seq\n    WHERE seq.i < JSON_ARRAY_LENGTH(custom_fields)\n  )\n\nSELECT ticket_id\n    , JSON_EXTRACT_PATH_TEXT(js, 'id') as field_name\n    , JSON_EXTRACT_PATH_TEXT(js, 'value') as field_value\nFROM cte;\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2961039":{"id":2961039,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-181,"y":-61,"width":32,"height":32,"inputConnectorIDs":[2961032],"outputSuccessConnectorIDs":[2961033],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"parse ticket tags field"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create temp table maps as \nwith tmp as (\n  select id as zendesk_tickets_id,\n        tags\n  from prod_zendesk.zendesk_tickets\n  )\n  \n  , numbers as (\n    select 1 as n union all\n    select 2 union all\n    select 3 union all\n    select 4 union all\n    select 5 union all\n    select 6 union all\n    select 7 union all\n    select 8 union all\n    select 9 union all\n    select 10 \n    )     \n     \n    , tmp2  as (\n  select zendesk_tickets_id\n        ,split_part(tags, ',', n) AS tag_name\n  from tmp\n    cross join numbers\n  where split_part(tags, ',', n) is not null\n    and split_part(tags, ',' ,n) != '')\n\nselect zendesk_tickets_id\n  , tag_name \nfrom tmp2;    \n  \n\n--select * from maps limit 10\ndrop table if exists prod_zendesk.lkp_zendesk_ticket_tags;\ncreate table prod_zendesk.lkp_zendesk_ticket_tags\n(lkp_zendesk_ticket_tags_id bigint identity(1,1) ,tag_name varchar(2000));\n\ninsert into prod_zendesk.lkp_zendesk_ticket_tags(tag_name)\nselect distinct tag_name\nfrom maps;\n\n--select * from lkp_zendesk_ticket_tags\ndrop table if exists prod_zendesk.zendesk_ticket_tags;\ncreate table prod_zendesk.zendesk_ticket_tags\n(zendesk_ticket_tags_id bigint identity(1, 1)\n,zendesk_tickets_id numeric(20)\n,lkp_zendesk_ticket_tags_id bigint);\n\ninsert into prod_zendesk.zendesk_ticket_tags(zendesk_tickets_id, lkp_zendesk_ticket_tags_id)\nselect m.zendesk_tickets_id \n      ,l.lkp_zendesk_ticket_tags_id\nfrom maps m\n  join prod_zendesk.lkp_zendesk_ticket_tags l on m.tag_name = l.tag_name; \n  "}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2961033":{"id":2961033,"sourceID":2961039,"targetID":2961038}},"failureConnectors":{},"unconditionalConnectors":{"2961032":{"id":2961032,"sourceID":2961036,"targetID":2961039},"2961035":{"id":2961035,"sourceID":2961037,"targetID":2961036}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"Zendesk_Custom_field_Parse","description":"","type":"ORCHESTRATION","tag":"77d50725-9ca4-40e6-976d-06bb259cb737"}}