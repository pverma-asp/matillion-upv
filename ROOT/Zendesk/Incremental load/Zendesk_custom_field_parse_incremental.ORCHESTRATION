{"job":{"components":{"2961089":{"id":2961089,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-144,"y":-64,"width":32,"height":32,"inputConnectorIDs":[2961091],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2961090],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"parse ticket custom json field"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists rdl.zendesk_ticket_custom_fields_new;\ncreate table rdl.zendesk_ticket_custom_fields_new (\n  zendesk_ticket_custom_fields_id bigint identity(1, 1) encode delta,\n  ticket_id numeric(20) encode zstd,\n  field_name varchar(1000) encode zstd,\n  field_value varchar(1000) encode zstd\n)\nDISTKEY(ticket_id)\nSORTKEY(ticket_id,field_name)\n;\n\n\nInsert into rdl.zendesk_ticket_custom_fields_new\n(ticket_id, field_name, field_value)\nWITH temp as (\n    SELECT id as ticket_id, custom_fields\n    FROM prod_zendesk.zendesk_tickets_incremental\n    )\n\n   ,cte AS (\n    SELECT ticket_id, JSON_EXTRACT_ARRAY_ELEMENT_TEXT(custom_fields, seq.i) AS js\n    FROM temp\n      cross join (select *\n                  from etl.numbers\n                  where i < 50) as seq\n    WHERE seq.i < JSON_ARRAY_LENGTH(custom_fields)\n  )\nSELECT ticket_id\n    , JSON_EXTRACT_PATH_TEXT(js, 'id')::varchar(1000) as field_name\n    , JSON_EXTRACT_PATH_TEXT(js, 'value')::varchar(1000) as field_value\nFROM cte;\n\nalter table rdl.zendesk_ticket_custom_fields\nrename to zendesk_ticket_custom_fields_old;\n\nalter table rdl.zendesk_ticket_custom_fields_new\nrename to zendesk_ticket_custom_fields;\n\ndrop table rdl.zendesk_ticket_custom_fields_old;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2961092":{"id":2961092,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-448,"y":-64,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2961088],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2961094":{"id":2961094,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":48,"y":-64,"width":32,"height":32,"inputConnectorIDs":[2961090],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"parse ticket tags field"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists rdl.lkp_zendesk_ticket_tags_new;\ncreate table rdl.lkp_zendesk_ticket_tags_new\n(\n  lkp_zendesk_ticket_tags_id bigint identity(1,1) encode zstd,\n  tag_name varchar(2000) encode zstd\n);\n\ndrop table if exists maps;\ncreate temp table maps as\nwith tmp as (\n  select id as zendesk_tickets_id,\n        tags\n  from prod_zendesk.zendesk_tickets_incremental\n  )\n\n  , numbers as (\n    select 1 as n union all\n    select 2 union all\n    select 3 union all\n    select 4 union all\n    select 5 union all\n    select 6 union all\n    select 7 union all\n    select 8 union all\n    select 9 union all\n    select 10\n    )\n\n    , tmp2  as (\n  select zendesk_tickets_id,\n         split_part(tags, ',', n) AS tag_name\n  from tmp\n    cross join numbers\n  where split_part(tags, ',', n) is not null\n    and split_part(tags, ',' ,n) != '')\n\nselect zendesk_tickets_id,\n       tag_name\nfrom tmp2;\n\ninsert into rdl.lkp_zendesk_ticket_tags_new(tag_name)\nselect distinct tag_name\nfrom maps;\n\ndrop table if exists rdl.zendesk_ticket_tags_incremental_new;\ncreate table rdl.zendesk_ticket_tags_incremental_new\n(\n  zendesk_ticket_tags_id bigint identity(1, 1) encode delta,\n  zendesk_tickets_id numeric(20) encode zstd,\n  lkp_zendesk_ticket_tags_id bigint encode zstd\n);\n\ninsert into rdl.zendesk_ticket_tags_incremental_new\n(\n  zendesk_tickets_id,\n  lkp_zendesk_ticket_tags_id\n)\nselect m.zendesk_tickets_id,\n       l.lkp_zendesk_ticket_tags_id\nfrom maps m\njoin rdl.lkp_zendesk_ticket_tags_new l on m.tag_name = l.tag_name;\n\nalter table rdl.lkp_zendesk_ticket_tags\nrename to lkp_zendesk_ticket_tags_old;\n\nalter table rdl.lkp_zendesk_ticket_tags_new\nrename to lkp_zendesk_ticket_tags;\n\ndrop table rdl.lkp_zendesk_ticket_tags_old;\n\nalter table rdl.zendesk_ticket_tags_incremental\nrename to zendesk_ticket_tags_incremental_old;\n\nalter table rdl.zendesk_ticket_tags_incremental_new\nrename to zendesk_ticket_tags_incremental;\n\ndrop table rdl.zendesk_ticket_tags_incremental_old;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2961095":{"id":2961095,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-314,"y":-65,"width":32,"height":32,"inputConnectorIDs":[2961088],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2961091],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"parse user custom json fields"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists rdl.zendesk_user_custom_fields_new;\ncreate table rdl.zendesk_user_custom_fields_new\n(\n  zendesk_user_custom_fields_id bigint encode zstd,\n  user_id numeric(20) encode zstd,\n  field_name varchar(500) encode zstd,\n  field_value varchar(1000) encode zstd\n)\nDISTKEY(user_id)\nSORTKEY(user_id,field_name)\n;\n\nInsert into rdl.zendesk_user_custom_fields_new\n(zendesk_user_custom_fields_id, user_id, field_name, field_value)\nwith tmp as (\n    select id as user_id,\n          user_fields\n    from prod_zendesk.zendesk_users_incremental\n    where user_fields is not null\n    )\n\n    , tmp1 as (\n      select user_id,\n          replace(replace(replace(user_fields, '{', ''), '}', ''), '\"', '') as user_fields\n      from tmp)\n\n    , numbers as (\n      select 1 as n union all\n      select 2 union all\n      select 3 union all\n      select 4 union all\n      select 5 union all\n      select 6 union all\n      select 7 union all\n      select 8 union all\n      select 9 union all\n      select 10 union all\n      select 11 union all\n      select 12 union all\n      select 13 union all\n      select 14 union all\n      select 15 union all\n      select 16 union all\n      select 17 union all\n      select 18 union all\n      select 19 union all\n      select 20\n      )\n\n    , tmp2  as (\n  select tmp1.user_id\n    ,trim(split_part(split_part(user_fields, ',', n), ': ', 1)) as field_name\n    ,trim(split_part(split_part(user_fields, ',', n), ': ', 2)) as field_value\n  from tmp1\n    cross join numbers\n  where split_part(user_fields, ',', n) is not null\n    and split_part(user_fields, ',' ,n) != '')\n\nselect row_number() over(order by user_id) as zendesk_user_custom_fields_id\n    ,user_id\n    ,field_name\n    ,field_value\nfrom tmp2;\n\nalter table rdl.zendesk_user_custom_fields\nrename to zendesk_user_custom_fields_old;\n\nalter table rdl.zendesk_user_custom_fields_new\nrename to zendesk_user_custom_fields;\n\ndrop table rdl.zendesk_user_custom_fields_old;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{},"unconditionalConnectors":{"2961088":{"id":2961088,"sourceID":2961092,"targetID":2961095},"2961090":{"id":2961090,"sourceID":2961089,"targetID":2961094},"2961091":{"id":2961091,"sourceID":2961095,"targetID":2961089}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"Zendesk_custom_field_parse_incremental","description":"","type":"ORCHESTRATION","tag":"cf346ba6-3372-424c-9d9d-08e6bb337bdc"}}