{"job":{"components":{"2966708":{"id":2966708,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":0,"y":96,"width":32,"height":32,"inputConnectorIDs":[2966733],"outputSuccessConnectorIDs":[2966704],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"check variables"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\nfrom datetime import datetime\nfrom datetime import timedelta\nfrom dateutil.relativedelta import relativedelta\nfrom pytz import timezone\n\n# print 'current time in PST: ', datetime.now(timezone('US/Pacific'))\n\n# today=datetime.now(timezone('US/Pacific')).strftime(\"%Y-%m-%d\")\n# print 'today: ', today\n\nprint '${current_year}-${current_month}-${current_day}'\n\n#context.updateVariable('file_date', file_date)\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966709":{"id":2966709,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2966706,2966733],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966710":{"id":2966710,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-247,"y":87,"width":32,"height":32,"inputConnectorIDs":[2966706],"outputSuccessConnectorIDs":[2966707],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"adhoc"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into unit21.EXTERNAL_INSTRUMENTS_ACH\n(INSTRUMENT_ID, ENTITY_NAME, ROUTING_NUMBER, ACCOUNT_NUMBER, DATE_CREATED)\nselect\n    instrument_id, entity_name, routing_number, account_number, date_created\nfrom UNIT21_SANDBOX.EXTERNAL_INSTRUMENTS_ACH\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966711":{"id":2966711,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":0,"y":208,"width":32,"height":32,"inputConnectorIDs":[2966704],"outputSuccessConnectorIDs":[2966705],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create external instruments ach"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"use warehouse unit_21;\n\n\ninsert into UNIT21.EXTERNAL_ENTITIES_ACH\n(EXTERNAL_ENTITY_ID, ENTITY_NAME)\nwith bank_names as (\n    select distinct upa.NAME\n    from WEB_DB.USER_PAYMENT_ACCOUNT upa\n    join WEB_DB.USER_PROFILE up on upa.USER_ID=up.USER_ID\n    where 1=1\n      and upa.DEPOSITORY_ID is null\n      and upa.CLASS='com.aspiration.bank.UserBankAccount'\n      and date_trunc('year',up.DATE_CREATED)='${current_year}-${current_month}-${current_day}'\n      and up.DATE_CREATED < '2021-06-19'\n\n)\nselect\n--     count(1/)\n    replace(uuid_string(), '-', '') as external_entity_id,\n    NAME as entity_name\nfrom bank_names\nwhere 1=1\n  and NAME not in (\n      select ENTITY_NAME\n      from UNIT21.EXTERNAL_ENTITIES_ACH\n    )\n;\n\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966714":{"id":2966714,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-368,"y":144,"width":32,"height":32,"inputConnectorIDs":[2966707],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fix permission"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"GRANT USAGE ON SCHEMA ADW.UNIT21 TO DATA_ENGINEERING_GROUP;\n\nGRANT SELECT ON ALL TABLES IN SCHEMA ADW.UNIT21 TO DATA_ENGINEERING_GROUP;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966715":{"id":2966715,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":0,"y":304,"width":32,"height":32,"inputConnectorIDs":[2966705],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"extract external instruments ach"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"use warehouse unit_21;\n\n\ncreate or replace file format UNIT21_JSON_FORMAT \n  type = 'JSON'\n  comment = 'JSON format for unit21 export files'\n;\n\n\ncopy into @public.DATATEAM/dump/jchen/unit21/historical_load/external_entity_ach_extract_historical_${current_year}${current_month}${current_day}.json\nfrom (\n\nselect\narray_agg(objs) from (\n        select\n            object_construct(\n                'general_data', object_construct(\n                    'entity_id', eea.EXTERNAL_ENTITY_ID,\n                    'entity_type', 'business',\n                    'entity_subtype', '',\n                    'status', 'active'\n                )\n                ,'business_data', object_construct(\n                    'business_name', eea.ENTITY_NAME\n                )\n            ) as objs\n    from unit21.EXTERNAL_ENTITIES_ACH eea\n    where 1=1\n      and ENTITY_NAME not in ('Aspiration Spend', 'Aspiration Save')\n      and ENTITY_NAME in (\n          select distinct name\n          from WEB_DB.USER_PAYMENT_ACCOUNT upa\n          join WEB_DB.USER_PROFILE up on upa.USER_ID=up.USER_ID\n          where 1=1\n            and date_trunc('year',up.DATE_CREATED)='${current_year}-${current_month}-${current_day}'\n      )\n\n    )\n\n)\nfile_format = (format_name = UNIT21_JSON_FORMAT, compression = NONE)\nSINGLE=true\n;\n\n\ninsert into UNIT21.EXTERNAL_ENTITIES_ACH_LOAD_STATUS\n\t(EXTERNAL_ENTITY_ID, FILENAME)\nselect\n    EXTERNAL_ENTITY_ID,\n    'external_entity_ach_extract_historical_${current_year}${current_month}${current_day}.json'\nfrom unit21.EXTERNAL_ENTITIES_ACH eea\nwhere 1=1\n  and ENTITY_NAME not in ('Aspiration Spend', 'Aspiration Save')\n  and ENTITY_NAME in (\n      select distinct name\n      from WEB_DB.USER_PAYMENT_ACCOUNT upa\n      join WEB_DB.USER_PROFILE up on upa.USER_ID=up.USER_ID\n      where 1=1\n        and date_trunc('year',up.DATE_CREATED)='${current_year}-${current_month}-${current_day}'\n  )\n  and EXTERNAL_ENTITY_ID not in (\n      select EXTERNAL_ENTITY_ID from UNIT21.EXTERNAL_ENTITIES_ACH_LOAD_STATUS\n    )\n;\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2966704":{"id":2966704,"sourceID":2966708,"targetID":2966711},"2966705":{"id":2966705,"sourceID":2966711,"targetID":2966715},"2966707":{"id":2966707,"sourceID":2966710,"targetID":2966714}},"failureConnectors":{},"unconditionalConnectors":{"2966706":{"id":2966706,"sourceID":2966709,"targetID":2966710},"2966733":{"id":2966733,"sourceID":2966709,"targetID":2966708}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"current_day":{"definition":{"name":"current_day","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"01"},"current_month":{"definition":{"name":"current_month","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"01"},"current_year":{"definition":{"name":"current_year","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"2014"}},"grids":{}},"info":{"name":"external_instrument_ach_historical_load_year","description":"","type":"ORCHESTRATION","tag":"7f225776-04fb-42fd-bd0a-4f52bc82355c"}}