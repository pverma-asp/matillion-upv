{"job":{"components":{"2966696":{"id":2966696,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":0,"y":96,"width":32,"height":32,"inputConnectorIDs":[2966693],"outputSuccessConnectorIDs":[2966698],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"check variables"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\nfrom datetime import datetime\nfrom datetime import timedelta\nfrom dateutil.relativedelta import relativedelta\nfrom pytz import timezone\n\n# print 'current time in PST: ', datetime.now(timezone('US/Pacific'))\n\n# today=datetime.now(timezone('US/Pacific')).strftime(\"%Y-%m-%d\")\n# print 'today: ', today\n\nprint '${current_year}-${current_month}-${current_day}'\n\n#context.updateVariable('file_date', file_date)\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966697":{"id":2966697,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":0,"y":208,"width":32,"height":32,"inputConnectorIDs":[2966698],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of extract internal instrument"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"use warehouse unit_21;\n\n\ncreate or replace file format UNIT21_JSON_FORMAT \n  type = 'JSON'\n  comment = 'JSON format for unit21 export files'\n;\n\n\ncopy into @public.DATATEAM/dump/jchen/unit21/historical_load/internal_instrument_extract_historical_${current_year}${current_month}${current_day}.json\nfrom (\n\nwith entity_data as (\n    select u.id                as user_id,\n           array_agg(\n                   object_construct(\n                           'entity_id', u.UUID,\n                           'entity_type', 'user'\n                       )\n               )               as entity_json,\n           min(u.DATE_CREATED) as DATE_CREATED\n    from WEB_DB._USER u\n    where 1 = 1\n--       and u.id = 2192747\n    group by u.id\n)\nselect\narray_agg(objs) from (\n        select\n            object_construct(\n                'instrument_id', upa.ACCOUNT_NUMBER,\n                'instrument_type', upa.NAME,\n                'source', 'internal',\n                'status', 'active',\n                'registered_at', DATE_PART(EPOCH_SECOND, CONVERT_TIMEZONE('America/Los_Angeles', 'UTC', upa.DATE_CREATED::timestamp )),\n                'entities', ed.entity_json\n            ) as objs\n        from WEB_DB.USER_PAYMENT_ACCOUNT upa\n        join WEB_DB.USER_PROFILE up on upa.USER_ID=up.USER_ID\n        left join entity_data ed on upa.USER_ID=ed.user_id\n        where 1=1\n          and upa.DEPOSITORY_ID is not null\n          and upa.name in ('Aspiration Spend', 'Aspiration Save')\n          and date_trunc('day',up.DATE_CREATED)='${current_year}-${current_month}-${current_day}'\n\n\n    )\n\n)\nfile_format = (format_name = UNIT21_JSON_FORMAT, compression = NONE)\nSINGLE=true\n;\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966699":{"id":2966699,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2966693],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2966698":{"id":2966698,"sourceID":2966696,"targetID":2966697}},"failureConnectors":{},"unconditionalConnectors":{"2966693":{"id":2966693,"sourceID":2966699,"targetID":2966696}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"current_day":{"definition":{"name":"current_day","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"01"},"current_month":{"definition":{"name":"current_month","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"06"},"current_year":{"definition":{"name":"current_year","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"2021"}},"grids":{}},"info":{"name":"internal_instrument_historical_load_day","description":"","type":"ORCHESTRATION","tag":"cd399bfd-fc88-4f35-8922-3d216fc45ed7"}}