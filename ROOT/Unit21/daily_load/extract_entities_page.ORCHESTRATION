{"job":{"components":{"2966869":{"id":2966869,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":0,"y":224,"width":32,"height":32,"inputConnectorIDs":[2966868],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"extract entites - page"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"use warehouse unit_21;\n\n\ncreate or replace file format UNIT21_JSON_FORMAT \n  type = 'JSON'\n  comment = 'JSON format for unit21 export files'\n;\n\n\ncopy into ${unit21_s3_staging_folder}/${file_date}/entity_extract_daily_${file_date}_page_${current_page_number}_seq_${sequence_number}.json\nfrom (\n\nwith email_data as (\n    select USER_ID,\n           array_agg(EMAIL) as emails\n    from WEB_DB.USER_EMAIL\n    where 1 = 1\n    group by USER_ID\n)\n, phone_data as (\n    select USER_ID,\n           array_agg('+1' || PHONE_NUMBER) as phone_numbers\n    from WEB_DB.USER_PROFILE\n    where 1 = 1\n    group by USER_ID\n)\n, address_data as (\n    select up.USER_ID,\n           array_agg(\n                   object_construct(\n                           'street_name', left(a.STREET1 || COALESCE(a.STREET2, ''), 128),\n                           'city', a.CITY,\n                           'state', s.CODE,\n                           'postal_code', a.ZIP_OR_POSTAL_CODE,\n                           'country', c.CODE\n                       )\n               ) as address_json_array\n    from WEB_DB.ADDRESS a\n             join WEB_DB.USER_PROFILE up on (up.ADDRESS_ID = a.ID or up.MAILING_ADDRESS_ID = a.ID)\n             join WEB_DB.STATE s on a.STATE_ID = s.ID\n             join WEB_DB.COUNTRY c on a.COUNTRY_ID = c.ID\n    where 1 = 1\n--   and up.USER_ID = 605772\n--   and up.USER_ID=1111966\n    group by up.USER_ID\n)\n, application_ip_addresses_raw as (\n    select USER_ID,\n           row_number() over (partition by USER_ID order by DATE_CREATED) as rn,\n           IP_ADDRESS,\n           DATE_CREATED\n    from WEB_DB.USER_PRODUCT_APPLICATION\n    where 1 = 1\n--       and USER_ID = 2192747\n)\n\n, application_ip_addresses as (\n    select USER_ID,\n           array_agg(\n                   object_construct(\n                           'ip_address', IP_ADDRESS,\n                           'first_seen', DATE_PART(EPOCH_SECOND, CONVERT_TIMEZONE('America/Los_Angeles', 'UTC',\n                                                                                  DATE_CREATED::timestamp)),\n                           'last_seen', DATE_PART(EPOCH_SECOND, CONVERT_TIMEZONE('America/Los_Angeles', 'UTC',\n                                                                                 DATE_CREATED::timestamp))\n                       )\n               ) as ip_addresses\n    from application_ip_addresses_raw\n    where 1 = 1\n      and rn = 1\n      and IP_ADDRESS is not null\n    group by USER_ID\n)\n\nselect\narray_agg(objs) from (\n        select\n            object_construct(\n                'general_data', object_construct(\n                    'entity_id', u.UUID,\n                    'entity_type', 'user',\n                    'entity_subtype', '',\n                    'status', case\n                        when u.ENABLED then 'active'\n                        else 'suspended' end,\n                    'registered_at', DATE_PART(EPOCH_SECOND, CONVERT_TIMEZONE('America/Los_Angeles', 'UTC', u.DATE_CREATED::timestamp ))\n                )\n                ,'user_data', object_construct(\n                    'first_name', up.FIRST_NAME,\n                    'middle_name', up.MIDDLE_NAME,\n                    'last_name', up.LAST_NAME,\n--                     'date_of_birth', up.DATE_OF_BIRTH,\n                    'day_of_birth', DATE_PART(DAY, up.DATE_OF_BIRTH),\n                    'month_of_birth', DATE_PART(MONTH, up.DATE_OF_BIRTH),\n                    'year_of_birth', DATE_PART(YEAR, up.DATE_OF_BIRTH),\n                    'gender', case\n                        when up.GENDER_TYPE=1 then 'male'\n                        when up.GENDER_TYPE=2 then 'female'\n                        else 'other' end,\n                    'ssn', substr(TAX_IDENTIFICATION_NUMBER, 1, 3) || '-' || substr(TAX_IDENTIFICATION_NUMBER, 4, 2) || '-' || substr(TAX_IDENTIFICATION_NUMBER, 6, 4)\n                )\n                ,'communication_data', object_construct(\n                    'email_addresses', ed.emails,\n                    'phone_numbers', pd.phone_numbers\n                )\n                , 'location_data', ad.address_json_array\n                , 'digital_data', object_construct(\n                    'ip_addresses', aia.ip_addresses\n                )\n            ) as objs\n        from WEB_DB._USER u\n        join WEB_DB.USER_PROFILE up on u.id=up.USER_ID\n        join email_data ed on u.id=ed.USER_ID\n        join phone_data pd on u.id=pd.USER_ID\n        join PCI.USER_PROFILE upsin on u.id=upsin.USER_ID and upsin.TAX_IDENTIFICATION_NUMBER is not null and upsin.TAX_IDENTIFICATION_NUMBER != ''\n        left join address_data ad on u.id=ad.USER_ID\n        left join application_ip_addresses aia on u.id=aia.USER_ID\n        join unit21.ENTITY_PAGINATION ep on ep.USER_ID=up.USER_ID\n        where 1=1\n--           and u.UUID='df0c40c91dc645b0a06c266c247f8448'\n--           and u.id in (605772, 1111966)\n--           and u.id=2449314  -- hacked client\n          and date_trunc('day',up.DATE_CREATED)='${current_post_date}'\n          and ep.page_number='${current_page_number}'\n  \n    )\n\n)\nfile_format = (format_name = UNIT21_JSON_FORMAT, compression = NONE)\nSINGLE=true\n;\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966874":{"id":2966874,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":0,"y":112,"width":32,"height":32,"inputConnectorIDs":[2966871],"outputSuccessConnectorIDs":[2966868],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of check variables"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\nfrom datetime import datetime\nfrom datetime import timedelta\nfrom dateutil.relativedelta import relativedelta\nfrom pytz import timezone\n\n# print 'current time in PST: ', datetime.now(timezone('US/Pacific'))\n\n# today=datetime.now(timezone('US/Pacific')).strftime(\"%Y-%m-%d\")\n# print 'today: ', today\n\nprint 'post_date: ${current_post_date}'\nprint 'page_number: ${current_page_number}'\n\nfile_date=current_post_date.replace('-', '')\ncontext.updateVariable('file_date', file_date)\nprint \"file_date, ${file_date}\"\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966875":{"id":2966875,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2966871],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2966868":{"id":2966868,"sourceID":2966874,"targetID":2966869}},"failureConnectors":{},"unconditionalConnectors":{"2966871":{"id":2966871,"sourceID":2966875,"targetID":2966874}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"current_filename":{"definition":{"name":"current_filename","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"entity_extract_daily_2021-08-11_page_1.json"},"current_page_number":{"definition":{"name":"current_page_number","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"1"},"current_post_date":{"definition":{"name":"current_post_date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"2021-08-11"},"file_date":{"definition":{"name":"file_date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"20210811"},"sequence_number":{"definition":{"name":"sequence_number","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"001"},"unit21_s3_staging_folder":{"definition":{"name":"unit21_s3_staging_folder","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"@public.ASPIRATION_DATA_UNIT21/daily_load"}},"grids":{}},"info":{"name":"extract_entities_page","description":"","type":"ORCHESTRATION","tag":"0b2db2d2-2eb3-409e-a4ce-a29153587096"}}