{"job":{"components":{"2967568":{"id":2967568,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1785813072,"x":-992,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2967613],"outputSuccessConnectorIDs":[2967614],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"get galileo file"}}}},"visible":true},"2":{"slot":2,"name":"Orchestration Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Subscription Billing Transfer Galileo Files"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"job_file_to_decrypt"},"2":{"slot":2,"type":"STRING","value":"${s3_path}/${galileo_file_name}.out.gpg"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"job_response_file_path"},"2":{"slot":2,"type":"STRING","value":"${response_file_path}"}}},"3":{"slot":3,"values":{"1":{"slot":1,"type":"STRING","value":"job_s3_file_name"},"2":{"slot":2,"type":"STRING","value":"${s3_path}/${galileo_file_name}.out.gpg"}}},"4":{"slot":4,"values":{"1":{"slot":1,"type":"STRING","value":"job_s3_file_path"},"2":{"slot":2,"type":"STRING","value":"${s3_path}"}}},"5":{"slot":5,"values":{"1":{"slot":1,"type":"STRING","value":"job_galileo_output_file_name"},"2":{"slot":2,"type":"STRING","value":"${galileo_output_file_name}"}}},"6":{"slot":6,"values":{"1":{"slot":1,"type":"STRING","value":"job_send_or_get"},"2":{"slot":2,"type":"STRING","value":"${send_or_get}"}}},"7":{"slot":7,"values":{"1":{"slot":1,"type":"STRING","value":"job_db_file_name"},"2":{"slot":2,"type":"STRING","value":"${galileo_file_name}"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967569":{"id":2967569,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-1104,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2967608],"outputSuccessConnectorIDs":[2967613],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"set variable"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Updating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\n\ncontext.updateVariable('full_file_path', file_path + \"/\" + galileo_file_name + '.out')\ncontext.updateVariable('galileo_output_file_name', galileo_file_name + '.out.gpg')\ncontext.updateVariable('galileo_full_file_path', file_path + \"/\" + galileo_output_file_name)\nprint (full_file_path)\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967571":{"id":2967571,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":-862,"y":216,"width":32,"height":32,"inputConnectorIDs":[2967609],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967572":{"id":2967572,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-864,"y":112,"width":32,"height":32,"inputConnectorIDs":[2967611],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2967609],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"log load failure"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--log result\ninsert into etl.issue_log\n(issue_program, issue_description, issue_count, issue_object, issue_identifier)\nselect\n       'Subscription Billing Import',\n       'Failed to copy data into etl.subscription_billing_galileo_output_staging.',\n       null,\n       'etl.subscription_billing_galileo_output_staging',\n       '${galileo_file_name}' || '.out';"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967573":{"id":2967573,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-864,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2967614],"outputSuccessConnectorIDs":[2967615],"outputFailureConnectorIDs":[2967611],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{"1":{"slot":1,"fromId":null,"fromName":"Message","mapTo":"message"}},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"load into staging"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists etl.subscription_billing_galileo_output_staging;\ncreate table etl.subscription_billing_galileo_output_staging\n(\n  output_row varchar(2000)\n);\n\nCOPY INTO etl.subscription_billing_galileo_output_staging (output_row)\nFROM (SELECT $1\n      FROM '${full_file_path}')\nFILE_FORMAT = ETL.PLAIN_TEXT;\n\n--remove header and trailer\ndelete from etl.subscription_billing_galileo_output_staging \nwhere left(output_row,1) in ('H','T');"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967574":{"id":2967574,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-560,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2967612],"outputSuccessConnectorIDs":[2967551],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"update statuses"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists tmp_galileo_output;\ncreate temp table tmp_galileo_output as\nselect\n  s.subscription_billing_id,\n  case when o.galileo_response_code = '0000' then 'paid'\n       when o.galileo_response_code <> '0000' then 'error_from_galileo'\n       else 'no_status_from_galileo'\n  end as status,\n   o.galileo_response_code\nfrom etl.subscription_billing s\nleft join etl.subscription_billing_galileo_output o on s.batch_id = o.batch_id\n                                                   and s.galileo_file_record_number = o.record_number\nwhere s.galileo_file_name = '${galileo_file_name}';\n\nupdate etl.subscription_billing s\nset status = o.status,\n    galileo_response_code = o.galileo_response_code,\n    modified_at = current_timestamp\nfrom tmp_galileo_output o\nwhere s.subscription_billing_id = o.subscription_billing_id;\n\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967575":{"id":2967575,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-720,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2967615],"outputSuccessConnectorIDs":[2967612],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into output table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists tmp_output;\ncreate temp table tmp_output as\n  select\n    substring(output_row,1,1) as record_type,\n    substring(output_row,2,6) as record_number,\n    substring(output_row,8,1) as account_id_type,\n    substring(output_row,9,50) as account_identifier,\n    substring(output_row,59,20) as transaction_identifier,\n    substring(output_row,79,4) as galileo_response_code\n  from etl.subscription_billing_galileo_output_staging;\n\ndelete from etl.subscription_billing_galileo_output\nwhere batch_id = '${batch_id}'\nand record_number in (select record_number from tmp_output);\n\ninsert into etl.subscription_billing_galileo_output\n(\n    batch_id,\n    galileo_output_file_name,\n    record_type,\n    record_number,\n    account_id_type,\n    account_identifier,\n    transaction_identifier,\n    galileo_response_code  \n)  \nselect\n  '${batch_id}',\n  '${galileo_file_name}' || '.out',\n  record_type,\n  record_number,\n  account_id_type,\n  trim(account_identifier),\n  trim(transaction_identifier),\n  galileo_response_code   \nfrom tmp_output;  \n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967576":{"id":2967576,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-1232,"y":-16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2967608],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967578":{"id":2967578,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-432,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2967551],"outputSuccessConnectorIDs":[2967570],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"log result"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--log results\n\n--imported file success\ninsert into etl.issue_log\n(issue_program, issue_description, issue_count, issue_object, issue_identifier, issue_priority)\nselect\n       'Subscription Billing Import',\n       'Output file successfully imported from Galileo',\n        count(*) as record_count,\n       'etl.subscription_billing',\n       'galileo_file_name = ${galileo_file_name}',\n       'low'\nfrom etl.subscription_billing f \nwhere galileo_file_name = '${galileo_file_name}'\nand galileo_response_code is not null\nhaving record_count > 0;\n\n--missing galileo status\ninsert into etl.issue_log\n(issue_program, issue_description, issue_count, issue_object, issue_identifier, issue_priority)\nselect\n       'Subscription Billing Import',\n       'Missing status from Galileo',\n        count(*) as record_count,\n       'etl.subscription_billing',\n       'galileo_file_name = ${galileo_file_name} and  status = no_status_from_galileo',\n       'high'\nfrom etl.subscription_billing f \nwhere galileo_file_name = '${galileo_file_name}'\nand status = 'no_status_from_galileo'\nhaving record_count > 0;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967579":{"id":2967579,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":-320,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2967570],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2967551":{"id":2967551,"sourceID":2967574,"targetID":2967578},"2967570":{"id":2967570,"sourceID":2967578,"targetID":2967579},"2967612":{"id":2967612,"sourceID":2967575,"targetID":2967574},"2967613":{"id":2967613,"sourceID":2967569,"targetID":2967568},"2967614":{"id":2967614,"sourceID":2967568,"targetID":2967573},"2967615":{"id":2967615,"sourceID":2967573,"targetID":2967575}},"failureConnectors":{"2967611":{"id":2967611,"sourceID":2967573,"targetID":2967572}},"unconditionalConnectors":{"2967608":{"id":2967608,"sourceID":2967576,"targetID":2967569},"2967609":{"id":2967609,"sourceID":2967572,"targetID":2967571}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"batch_id":{"definition":{"name":"batch_id","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"abcde"},"file_path":{"definition":{"name":"file_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"@PUBLIC.ASPIRATION_PROD_DATA_PLANET_PROTECTION/subscription-billing/from-galileo"},"full_file_path":{"definition":{"name":"full_file_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"@PUBLIC.ASPIRATION_PROD_DATA_PLANET_PROTECTION/subscription-billing/from-galileo/btrans_584_20200911_sub102128.txt.out"},"galileo_file_name":{"definition":{"name":"galileo_file_name","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"btrans_584_20200911_sub102128.txt"},"galileo_full_file_path":{"definition":{"name":"galileo_full_file_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"none"},"galileo_output_file_name":{"definition":{"name":"galileo_output_file_name","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"none"},"message":{"definition":{"name":"message","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"none"},"response_file_path":{"definition":{"name":"response_file_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"/sftpdir/response"},"s3_path":{"definition":{"name":"s3_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"s3://aspiration-prod-data-planet-protection/subscription-billing/from-galileo"},"send_or_get":{"definition":{"name":"send_or_get","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"get"}},"grids":{}},"info":{"name":"Subscription Billing Process Import","description":"Processes Galileo output files for subscription billing transactions.  Initially created for Planet Protection.","type":"ORCHESTRATION","tag":"18cd8c5f-0a81-4528-9f3c-b756818b2c61"}}