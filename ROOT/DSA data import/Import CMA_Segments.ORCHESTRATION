{"job":{"components":{"2967152":{"id":2967152,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":144,"y":96,"width":32,"height":32,"inputConnectorIDs":[2967208],"outputSuccessConnectorIDs":[2967209],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert new data to history table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"-- delete from rdl.cma_segments_history\n-- where file_date='2022-01-20'\n-- ;\n\n\ninsert into etl.cma_segments_history_raw\n(FILE_NAME, FILE_DATE, UNIQUE_ACCOUNT_ID, SEGMENTS)\n\nwith a as (\n    select file_name,\n           file_date,\n           regexp_replace(value:c1, '\"|\\'', '')                                                    as unique_account_id,\n           regexp_replace(value:c32, '\"|\\'', '')::numeric(18, 2)                                   as segments,\n           row_number() over (partition by FILE_NAME,unique_account_id order by unique_account_id) as rn\n    from etl.CMA_SEGMENTS_STAGING\n    where 1 = 1\n      and FILE_NAME not in (\n        select distinct FILE_NAME\n        from rdl.cma_segments_history\n      )\n      and unique_account_id != 'UNIQUE_ACCOUNT_ID'\n      -- and unique_account_id = 'g1915819'\n)\nselect\n    FILE_NAME,\n    FILE_DATE,\n    unique_account_id,\n    segments\nfrom a\nwhere 1=1\n  and rn=1\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967153":{"id":2967153,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":0,"y":96,"width":32,"height":32,"inputConnectorIDs":[2967205],"outputSuccessConnectorIDs":[2967208],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Refresh external table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"alter external table etl.CMA_SEGMENTS_STAGING refresh;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967154":{"id":2967154,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1032749985,"x":304,"y":192,"width":32,"height":32,"inputConnectorIDs":[2967214],"outputSuccessConnectorIDs":[2967211],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Query record count"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select\n    count(1) as CNT\nfrom RDL.CMA_SEGMENTS_HISTORY\nwhere 1=1\n  and FILE_DATE=current_date"}}}},"visible":true},"3":{"slot":3,"name":"Scalar Variable Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"record_count"},"2":{"slot":2,"type":"STRING","value":"CNT"}}}},"visible":true},"4":{"slot":4,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"5":{"slot":5,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"6":{"slot":6,"name":"Table Columns","elements":{},"visible":false},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"10":{"slot":10,"name":"Limit","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"100"}}}},"visible":false},"11":{"slot":11,"name":"Order By","elements":{},"visible":false},"12":{"slot":12,"name":"Sort","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Ascending"}}}},"visible":false},"13":{"slot":13,"name":"Filter Conditions","elements":{},"visible":false},"14":{"slot":14,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AND"}}}},"visible":false},"20":{"slot":20,"name":"Basic / Advanced","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Advanced"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967155":{"id":2967155,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":144,"y":192,"width":32,"height":32,"inputConnectorIDs":[2967209],"outputSuccessConnectorIDs":[2967214],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Re-creation main table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create or replace table rdl.CMA_SEGMENTS_HISTORY_NEW\nas\nselect\n--     ,da.UNIQUE_ACCOUNT_ID\n--     ,da_rg.UNIQUE_ACCOUNT_ID\n--     ,da_sav.UNIQUE_ACCOUNT_ID\n    coalesce(da.UNIQUE_ACCOUNT_ID, da_rg.UNIQUE_ACCOUNT_ID, da_sav.UNIQUE_ACCOUNT_ID) as unique_account_id\n    , csh.FILE_NAME\n    , csh.FILE_DATE\n    , csh.SEGMENTS\n    , csh.ETL_LOAD_DATE\n    ,csh.UNIQUE_ACCOUNT_ID as original_unique_account_id\nfrom etl.CMA_SEGMENTS_HISTORY_RAW csh\nleft join bi.DT_ACCOUNTS da on csh.UNIQUE_ACCOUNT_ID=da.UNIQUE_ACCOUNT_ID\nleft join bi.DT_ACCOUNTS da_rg on csh.UNIQUE_ACCOUNT_ID=split_part(da_rg.UNIQUE_ACCOUNT_ID, 'g', 1)\nleft join bi.DT_ACCOUNTS da_sav on replace(csh.UNIQUE_ACCOUNT_ID, 'g', '') = da_sav.GALILEO_SAVE_ID::varchar\nwhere 1=1\n--   and da.UNIQUE_ACCOUNT_ID is null\n--   and unique_account_id_2 is null\n--   and UNIQUE_ACCOUNT_ID='g845524'\n;\n\n\nalter table rdl.CMA_SEGMENTS_HISTORY\nrename to rdl.CMA_SEGMENTS_HISTORY_OLD;\n\nalter table rdl.CMA_SEGMENTS_HISTORY_NEW\nrename to rdl.CMA_SEGMENTS_HISTORY;\n\ndrop table rdl.CMA_SEGMENTS_HISTORY_OLD;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967158":{"id":2967158,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-176,"y":112,"width":32,"height":32,"inputConnectorIDs":[2967204],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Table creation"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create table etl.CMA_SEGMENTS_HISTORY_RAW\n(\n    FILE_NAME VARCHAR(255),\n    FILE_DATE DATE,\n    UNIQUE_ACCOUNT_ID VARCHAR(255),\n    SEGMENTS NUMBER(18,0),\n    etl_load_date timestamp_tz default current_timestamp not null\n);\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967159":{"id":2967159,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2967204,2967205],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967212":{"id":2967212,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":544,"y":400,"width":32,"height":32,"inputConnectorIDs":[2967207],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure - zero records loaded"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967213":{"id":2967213,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"CONDITIONAL","executionHint":"FLOW","implementationID":-1357378929,"x":304,"y":304,"width":32,"height":32,"inputConnectorIDs":[2967211],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[2967210],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"If record count > 0"}}}},"visible":true},"2":{"slot":2,"name":"Mode","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Simple"}}}},"visible":true},"3":{"slot":3,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"record_count"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Greater than"},"4":{"slot":4,"type":"STRING","value":"0"}}}},"visible":true},"4":{"slot":4,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":true},"5":{"slot":5,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967215":{"id":2967215,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":438858066,"x":448,"y":304,"width":32,"height":32,"inputConnectorIDs":[2967210],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2967207],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send Alert to Pager Duty - Talkdesk Report"}}}},"visible":true},"2":{"slot":2,"name":"AWS Region","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"us-west-2"}}}},"visible":true},"3":{"slot":3,"name":"Topic Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"data-alerts-pagerduty-prod"}}}},"visible":true},"4":{"slot":4,"name":"Subject","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AWS Notification Message"}}}},"visible":true},"5":{"slot":5,"name":"Message","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"\"Import CMA_Segments\" job failed - no records loaded"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2967208":{"id":2967208,"sourceID":2967153,"targetID":2967152},"2967209":{"id":2967209,"sourceID":2967152,"targetID":2967155},"2967211":{"id":2967211,"sourceID":2967154,"targetID":2967213},"2967214":{"id":2967214,"sourceID":2967155,"targetID":2967154}},"failureConnectors":{},"unconditionalConnectors":{"2967204":{"id":2967204,"sourceID":2967159,"targetID":2967158},"2967205":{"id":2967205,"sourceID":2967159,"targetID":2967153},"2967207":{"id":2967207,"sourceID":2967215,"targetID":2967212}},"trueConnectors":{},"falseConnectors":{"2967210":{"id":2967210,"sourceID":2967213,"targetID":2967215}},"iterationConnectors":{},"noteConnectors":{},"notes":{"2967156":{"id":2967156,"x":484,"y":50,"width":250,"height":58,"text":"CSV file S3 location:\ns3://aspiration-datateam/dump/DSA_Reports/Data_Science/RFM_Segmentation/CMA_Segments_2022-01-15.csv","colour":"e6e63c"}},"variables":{"record_count":{"definition":{"name":"record_count","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"Import CMA_Segments","description":null,"type":"ORCHESTRATION","tag":"41d603ba-1402-40e1-94ae-4363214e4ffe"}}