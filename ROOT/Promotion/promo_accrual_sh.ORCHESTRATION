{"job":{"components":{"2966081":{"id":2966081,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":-1218,"y":-140,"width":32,"height":32,"inputConnectorIDs":[2966096],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966084":{"id":2966084,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":235671163,"x":-528,"y":-144,"width":32,"height":32,"inputConnectorIDs":[2966080,2966082,2966083],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2966100],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966085":{"id":2966085,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-416,"y":-144,"width":32,"height":32,"inputConnectorIDs":[2966100],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2966097],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"log success"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--log result\n\n--success\ninsert into etl.issue_log\n(issue_program, issue_description, issue_count, issue_object, issue_identifier, issue_priority)\nselect\n       'Promotion Accrual',\n       'Successfully inserted promo accrual',\n       null,\n       'PROMOTIONS.PROMO_ACCURAL',\n       'promo_name in (Scholly Promotion Credit,Plant Your Change Sweepstakes,Thank You Program)',\n       'low';\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966086":{"id":2966086,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-1104,"y":-144,"width":32,"height":32,"inputConnectorIDs":[2966099],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2966096],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"log failure"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--log result\n\n--success\ninsert into etl.issue_log\n(issue_program, issue_description, issue_count, issue_object, issue_identifier, issue_priority)\nselect\n       'Promotion Accrual',\n       'Failure occurred during promo_accrual_sh job',\n       null,\n       'PROMOTIONS.PROMO_ACCURAL',\n       'promo_name in (Scholly Promotion Credit,Plant Your Change Sweepstakes,Thank You Program)',\n       'high';\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966087":{"id":2966087,"inputCardinality":"MANY","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1343684451,"x":-992,"y":-144,"width":32,"height":32,"inputConnectorIDs":[2966144,2966145,2966150],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2966099],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Or"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966088":{"id":2966088,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-752,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2966098],"outputSuccessConnectorIDs":[2966082],"outputFailureConnectorIDs":[2966145],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"thank you program"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--delete records for current month if they exist\ndelete \nfrom PROMOTIONS.PROMO_ACCURAL\nwhere promo_name = 'Thank You Program'\nand date_trunc('month',date_created) = date_trunc('month', current_date);\n\n\n--insert new records\ninsert into PROMOTIONS.PROMO_ACCURAL\nwith next_month as (\n    select date, day_name\n    from dw.DATE_DIM\n    where date_trunc('month',date) = dateadd(month,1, date_trunc('month', current_date))\n    and DAY_NAME = 'Monday'\n)\nselect\n       'Thank You Program' as promo_name,\n       n.DATE as payout_date,\n       count(*) as total_payment_count,\n       sum(p.PAYMENT_AMOUNT) as total_payment_amount,\n       current_timestamp as date_created\nfrom PROMOTIONS.THANK_YOU_PROGRAM p\ncross join next_month n\nwhere p.PAYMENT_DATE = (select max(PAYMENT_DATE) from PROMOTIONS.THANK_YOU_PROGRAM)\nand p.STATUS = 'payment_successful'\ngroup by 2;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966089":{"id":2966089,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-752,"y":-240,"width":32,"height":32,"inputConnectorIDs":[2966149],"outputSuccessConnectorIDs":[2966083],"outputFailureConnectorIDs":[2966144],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"scholly promotion"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--delete records for current month if they exist\ndelete \nfrom PROMOTIONS.PROMO_ACCURAL\nwhere promo_name = 'Scholly Promotion Credit'\nand date_trunc('month',date_created) = date_trunc('month', current_date);\n\n\n--insert new records\ndrop table if exists etl.tmp_scholly;\ncreate table etl.tmp_scholly as\nwith scholly as (\n    select a.UNIQUE_ACCOUNT_ID,\n           ifnull(a.SPEND_GALILEO_PRN,a.SAVE_GALILEO_PRN) as prn,\n           convert_timezone('UTC','America/Los_Angeles',d.ACCOUNT_APPROVED_TIME::timestamp)::date as INCEPTION_DATE\n    from bi.DT_ACCOUNTS a\n    join bi.DT_USERS u on a.USER_ID = u.USER_ID\n    join WEB_DB.DEPOSITORY d on a.GALILEO_ID = d.id\n    where date_trunc('month', convert_timezone('UTC','America/Los_Angeles',d.ACCOUNT_APPROVED_TIME::timestamp)::date)\n            = date_trunc('month', current_date)\n    and u.UTM_SOURCE ilike '%scholly%'\n    and a.ACCOUNT_TYPE = 'Checking'\n    and a.SPEND_CURRENT_BALANCE >= 0\n    and a.SAVE_GALILEO_PRN >= 0\n    and a.TERMINATION_DATE is null\n)\n, daily_balance as (\n    select a.UNIQUE_ACCOUNT_ID,\n           ifnull(count(distinct a.DATE),0) as count_overdraft_days\n    from bi.DT_ACCOUNT_DAILY_DATA a\n    join scholly s on a.UNIQUE_ACCOUNT_ID = s.UNIQUE_ACCOUNT_ID\n    where a.DATE >= s.INCEPTION_DATE\n    and (a.SPEND_DAILY_BALANCE < 0\n          or a.SAVE_DAILY_BALANCE < 0)\n    group by 1\n)\n, result as (\n    select s.*\n    from scholly s\n    left join daily_balance d on s.UNIQUE_ACCOUNT_ID = d.UNIQUE_ACCOUNT_ID\n    left join rdl.scholly_promotion p on s.UNIQUE_ACCOUNT_ID = p.UNIQUE_ACCOUNT_ID\n    where d.UNIQUE_ACCOUNT_ID is null\n    and p.UNIQUE_ACCOUNT_ID is null\n)\n, bad_prn as (\n    select UNIQUE_ACCOUNT_ID\n    from result\n    where prn is null\n    or prn ilike '%x%'\n    or trim(prn) = ''\n)\n, duplicate as (\n    select UNIQUE_ACCOUNT_ID\n    from result\n    group by 1\n    having count(*) > 1\n)\nselect r.*,\n       case when b.UNIQUE_ACCOUNT_ID is not null then 'bad_prn'\n            when d.UNIQUE_ACCOUNT_ID is not null then 'duplicate_record'\n            else 'ready_for_export' end as status\nfrom result r\nleft join bad_prn b on r.UNIQUE_ACCOUNT_ID = b.UNIQUE_ACCOUNT_ID\nleft join duplicate d on r.UNIQUE_ACCOUNT_ID = d.UNIQUE_ACCOUNT_ID\nwhere status = 'ready_for_export';\n\ninsert into PROMOTIONS.PROMO_ACCURAL\nselect 'Scholly Promotion Credit' as promo_name,\n       dateadd(month,1, date_trunc('month', current_date)) as payout_date,\n       count(*) as total_payment_count,\n       count(*) * 25 as total_payment_amount,\n       current_timestamp as date_created\nfrom etl.tmp_scholly;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966090":{"id":2966090,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":-320,"y":-144,"width":32,"height":32,"inputConnectorIDs":[2966097],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Success"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966091":{"id":2966091,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-752,"y":-144,"width":32,"height":32,"inputConnectorIDs":[2966148],"outputSuccessConnectorIDs":[2966080],"outputFailureConnectorIDs":[2966150],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"plant your change sweepstakes"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"--delete records for current month if they exist\ndelete \nfrom PROMOTIONS.PROMO_ACCURAL\nwhere promo_name = 'Plant Your Change Sweepstakes'\nand date_trunc('month',date_created) = date_trunc('month', current_date);\n\n\n--insert new records\ninsert into PROMOTIONS.PROMO_ACCURAL\nwith month_data as (\n    select date_trunc('month', POST_DATE) as month_date,\n           sum(AMOUNT::decimal(12,2)) as month_total,\n           count(*) as month_count\n    from bi.DT_DEPOSITORY_TRANSACTIONS\n    where AMOUNT = 1000\n    and TRANSACTION_TYPE = 'Promotional Credit'\n    and DESCRIPTION = 'Aspiration Plant Your Change Sweepstakes'\n    group by 1\n)\n, avg_month as (\n    select round(avg(month_count)) as avg_count\n    from month_data\n)\nselect\n       'Plant Your Change Sweepstakes' as promo_name,\n       dateadd(day,19,dateadd(month,1, date_trunc('month', current_date))) as payout_date,\n       avg_count as total_payment_count,\n       avg_count * 1000 as total_payment_amount,\n       current_timestamp as date_created\nfrom avg_month;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2966094":{"id":2966094,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-752,"y":-336,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2966098,2966148,2966149],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2966080":{"id":2966080,"sourceID":2966091,"targetID":2966084},"2966082":{"id":2966082,"sourceID":2966088,"targetID":2966084},"2966083":{"id":2966083,"sourceID":2966089,"targetID":2966084}},"failureConnectors":{"2966144":{"id":2966144,"sourceID":2966089,"targetID":2966087},"2966145":{"id":2966145,"sourceID":2966088,"targetID":2966087},"2966150":{"id":2966150,"sourceID":2966091,"targetID":2966087}},"unconditionalConnectors":{"2966096":{"id":2966096,"sourceID":2966086,"targetID":2966081},"2966097":{"id":2966097,"sourceID":2966085,"targetID":2966090},"2966098":{"id":2966098,"sourceID":2966094,"targetID":2966088},"2966099":{"id":2966099,"sourceID":2966087,"targetID":2966086},"2966100":{"id":2966100,"sourceID":2966084,"targetID":2966085},"2966148":{"id":2966148,"sourceID":2966094,"targetID":2966091},"2966149":{"id":2966149,"sourceID":2966094,"targetID":2966089}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"job_ran":{"definition":{"name":"job_ran","type":"DECIMAL","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"1"}},"grids":{}},"info":{"name":"promo_accrual_sh","description":"add promo accrual data from Serena's promo jobs to PROMOTIONS.PROMO_ACCURAL.","type":"ORCHESTRATION","tag":"9ddea206-c45f-4511-94ff-33f9c8d95fb2"}}