{"job":{"components":{"2967025":{"id":2967025,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":160,"y":176,"width":32,"height":32,"inputConnectorIDs":[2967027],"outputSuccessConnectorIDs":[2967024],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create galileo account change table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"UPDATE etl.galileo_account_changes_batch_header\nSET file_name = '${galileo_filename}.gpg',\n       file_transmit_date = '${file_transmit_date}'\nWHERE record_type = 'H'\n;\n\ndelete from etl.galileo_account_changes_batch_detail;\ninsert into etl.galileo_account_changes_batch_detail(record_type, record_number, account_id_type, account_identifier, action_code, action_value)\n\nwith aplus_users as (\n    select ua.USER_ID\n--     distinct PLAN_ID\n    from WEB_DB.SUBSCRIPTION s\n             join WEB_DB.USER_ACCOUNT ua on s.ACCOUNT_ID = ua.ACCOUNT_ID\n    where 1 = 1\n      and plan_id ILIKE 'planet%protection%'\n      and status = 'active'\n)\n, pid_change_users as (\n    select ue.EMAIL,\n           ue.user_id,\n           ap.USER_ID is not null as has_aplus_plan\n    from WEB_DB.USER_EMAIL ue\n             left join aplus_users ap on ue.USER_ID = ap.USER_ID\n    where 1 = 1\n      and ue.IS_PRIMARY = true\n      and ue.EMAIL in (\n                       'mgiles@aspiration.com', 'rod@morison.io', 'dgoldsmith129@gmail.com', 'kevin.prentiss@gmail.com',\n                       'ethanschreiber@gmail.com', 'anders5.eric@gmail.com', 'mullingitover@gmail.com',\n                       'nima@jalali.net', 's.finkel@gmail.com'\n        )\n)\n, prns as (\n    select 'spend' as type,\n           da.USER_ID,\n           da.SPEND_GALILEO_PRN as prn\n--            '2512' as new_pid\n    from bi.DT_ACCOUNTS da\n    join pid_change_users pcu on da.USER_ID=pcu.USER_ID\n    where 1 = 1\n      and ACCOUNT_TYPE='Checking'\n\n    union all\n\n    select 'save',\n           da.USER_ID,\n           SAVE_GALILEO_PRN as prn\n--            '2513' as new_pid\n    from bi.DT_ACCOUNTS da\n    join pid_change_users pcu on da.USER_ID=pcu.USER_ID\n    where 1 = 1\n      and ACCOUNT_TYPE='Checking'\n)\nselect\n  'D' as record_type\n  ,row_number() over (order by prn) as recordnumber\n  ,'R' as accountidtype\n  ,prn::varchar as accountidentifier\n  ,'1' as actioncode\n--   , prns.type\n--   , u.has_aplus_plan\n  ,case\n    when prns.type='spend' and u.has_aplus_plan then 2512\n    when prns.type='spend' and not u.has_aplus_plan then 2511\n    when prns.type='save' then 2513\n   end as actionvalue\nfrom prns\njoin pid_change_users u on prns.USER_ID=u.USER_ID\nwhere 1=1\n  and prn is not null\n;\n\n\n--trailer data\nUPDATE etl.galileo_account_changes_batch_trailer\n   SET \"count\" = (select count(*) from etl.galileo_account_changes_batch_detail)\nWHERE record_type = 'T';\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967028":{"id":2967028,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2967026],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967030":{"id":2967030,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1785813072,"x":160,"y":288,"width":32,"height":32,"inputConnectorIDs":[2967024],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send_BChanges_File_to_Galileo 0"}}}},"visible":true},"2":{"slot":2,"name":"Orchestration Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send_BChanges_File_to_Galileo"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"galileo_filename"},"2":{"slot":2,"type":"STRING","value":"${galileo_filename}"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967031":{"id":2967031,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":128,"y":64,"width":32,"height":32,"inputConnectorIDs":[2967026],"outputSuccessConnectorIDs":[2967027],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"load ato user ids"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create table etl.ato_user_ids_20210601 as\nwith user_ids as (\n    select distinct message:user_id as user_id\n    from events_db.domain_event\n    where type = 'Session'\n      and subtype = 'Request'\n      and message: language = 'de-DE,de;q=0.9,en-US;q=0.8,en;q=0.7'\n      and created_at >= '2021-05-01'\n),\nuser_id_cma as (\n     select distinct ua.user_id\n     from web_db.user_account ua\n              inner join web_db.account a on a.id = ua.account_id\n              inner join web_db.depository d on d.account_id = a.id\n     where d.product_id in ('4', '5')\n       and ua.user_id in (select user_id from user_ids)\n)\nselect *\nfrom user_id_cma\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2967024":{"id":2967024,"sourceID":2967025,"targetID":2967030},"2967027":{"id":2967027,"sourceID":2967031,"targetID":2967025}},"failureConnectors":{},"unconditionalConnectors":{"2967026":{"id":2967026,"sourceID":2967028,"targetID":2967031}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"file_transmit_date":{"definition":{"name":"file_transmit_date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"06042021"},"galileo_filename":{"definition":{"name":"galileo_filename","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"bchanges_584_20210604_001.txt"}},"grids":{}},"info":{"name":"20210604_pid_change_internal_test_users","description":"","type":"ORCHESTRATION","tag":"b8f78fd7-5c8f-47cf-bcda-8a871f09cd81"}}