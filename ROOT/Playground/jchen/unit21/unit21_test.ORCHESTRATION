{"job":{"components":{"2959360":{"id":2959360,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":144,"y":144,"width":32,"height":32,"inputConnectorIDs":[2959363],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"unit21 test - extract entity"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create or replace file format UNIT21_JSON_FORMAT \n  type = 'JSON'\n  comment = 'JSON format for unit21 export files'\n;\n\n\ncopy into @public.DATATEAM/dump/jchen/unit21/entity_test_014.json\nfrom (\n\nwith email_data as (\n    select USER_ID,\n           array_agg(EMAIL) as emails\n    from WEB_DB.USER_EMAIL\n    where 1 = 1\n    group by USER_ID\n)\n, phone_data as (\n    select USER_ID,\n           array_agg('+1' || PHONE_NUMBER) as phone_numbers\n    from WEB_DB.USER_PROFILE\n    where 1 = 1\n    group by USER_ID\n)\n, address_data as (\n    select up.USER_ID,\n           array_agg(\n                   object_construct(\n                           'street_name', a.STREET1 || COALESCE(a.STREET2, ''),\n                           'city', a.CITY,\n                           'state', s.CODE,\n                           'postal_code', a.ZIP_OR_POSTAL_CODE,\n                           'country', c.CODE\n                       )\n               ) as address_json_array\n    from WEB_DB.ADDRESS a\n             join WEB_DB.USER_PROFILE up on (up.ADDRESS_ID = a.ID or up.MAILING_ADDRESS_ID = a.ID)\n             join WEB_DB.STATE s on a.STATE_ID = s.ID\n             join WEB_DB.COUNTRY c on a.COUNTRY_ID = c.ID\n    where 1 = 1\n--   and up.USER_ID = 605772\n--   and up.USER_ID=1111966\n    group by up.USER_ID\n)\n, application_ip_addresses_raw as (\n    select USER_ID,\n           row_number() over (partition by USER_ID order by DATE_CREATED) as rn,\n           IP_ADDRESS,\n           DATE_CREATED\n    from WEB_DB.USER_PRODUCT_APPLICATION\n    where 1 = 1\n--       and USER_ID = 2192747\n)\n, application_ip_addresses as (\n    select USER_ID,\n           array_agg(\n                   object_construct(\n                           'ip_address', IP_ADDRESS,\n                           'first_seen', DATE_PART(EPOCH_SECOND, CONVERT_TIMEZONE('America/Los_Angeles', 'UTC',\n                                                                                  DATE_CREATED::timestamp)),\n                           'last_seen', DATE_PART(EPOCH_SECOND, CONVERT_TIMEZONE('America/Los_Angeles', 'UTC',\n                                                                                 DATE_CREATED::timestamp))\n                       )\n               ) as ip_addresses\n    from application_ip_addresses_raw\n    where 1 = 1\n      and rn = 1\n    group by USER_ID\n)\n\nselect\narray_agg(objs) from (\n        select\n            object_construct(\n                'general_data', object_construct(\n                    'entity_id', u.UUID,\n                    'entity_type', 'user',\n                    'entity_subtype', '',\n                    'status', 'active',\n                    'registered_at', DATE_PART(EPOCH_SECOND, CONVERT_TIMEZONE('America/Los_Angeles', 'UTC', u.DATE_CREATED::timestamp ))\n                )\n                ,'user_data', object_construct(\n                    'first_name', up.FIRST_NAME,\n                    'middle_name', up.MIDDLE_NAME,\n                    'last_name', up.LAST_NAME,\n--                     'date_of_birth', up.DATE_OF_BIRTH,\n                    'day_of_birth', DATE_PART(DAY, up.DATE_OF_BIRTH),\n                    'month_of_birth', DATE_PART(MONTH, up.DATE_OF_BIRTH),\n                    'year_of_birth', DATE_PART(YEAR, up.DATE_OF_BIRTH),\n                    'gender', case\n                        when up.GENDER_TYPE=1 then 'male'\n                        when up.GENDER_TYPE=2 then 'female'\n                        else 'other' end\n                )\n                ,'communication_data', object_construct(\n                    'email_addresses', ed.emails,\n                    'phone_numbers', pd.phone_numbers\n                )\n                , 'location_data', ad.address_json_array\n                , 'digital_data', object_construct(\n                    'ip_addresses', aia.ip_addresses\n                )\n            ) as objs\n        from WEB_DB._USER u\n        join WEB_DB.USER_PROFILE up on u.id=up.USER_ID\n        join email_data ed on u.id=ed.USER_ID\n        join phone_data pd on u.id=pd.USER_ID\n        left join address_data ad on u.id=ad.USER_ID\n        left join application_ip_addresses aia on u.id=aia.USER_ID\n        where 1=1\n--           and u.UUID='df0c40c91dc645b0a06c266c247f8448'\n--           and u.id in (605772, 1111966)\n          and u.id=2192747\n\n--           and u.id in (\n--               select user_id\n--               from ujc.active_customers\n--               where 1=1\n--                 and INCEPTION_DATE = '2021-01-01'\n--             )\n\n--         limit 2\n    )\n\n)\nfile_format = (format_name = UNIT21_JSON_FORMAT, compression = NONE)\nSINGLE=true\n;\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959361":{"id":2959361,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-112,"y":112,"width":32,"height":32,"inputConnectorIDs":[2959389],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create temp table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"alter table web_db.product_waitlist\nadd column is_invited boolean\n;\n\n\nalter table web_db_stg.product_waitlist\nadd column is_invited boolean\n;\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959366":{"id":2959366,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":16,"y":144,"width":32,"height":32,"inputConnectorIDs":[2959362],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"adhoc unit21"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create or replace file format UNIT21_JSON_FORMAT \n  type = 'JSON'\n  comment = 'JSON format for unit21 export files'\n;\n\n\ncopy into @public.DATATEAM/dump/jchen/unit21/311.json\nfrom (\n\nselect\narray_agg(objs) from (\n        select\n        object_construct(\n                'id', ID,\n                'uuid', UUID\n            ) as objs\n        from WEB_DB._USER u\n        limit 5\n    )\n\n)\nfile_format = (format_name = UNIT21_JSON_FORMAT, compression = NONE)\nSINGLE=true\n;\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959367":{"id":2959367,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2959362,2959363,2959389],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{},"unconditionalConnectors":{"2959362":{"id":2959362,"sourceID":2959367,"targetID":2959366},"2959363":{"id":2959363,"sourceID":2959367,"targetID":2959360},"2959389":{"id":2959389,"sourceID":2959367,"targetID":2959361}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{},"grids":{}},"info":{"name":"unit21_test","description":"","type":"ORCHESTRATION","tag":"937547ef-397d-4611-a18d-e968b213cebf"}}