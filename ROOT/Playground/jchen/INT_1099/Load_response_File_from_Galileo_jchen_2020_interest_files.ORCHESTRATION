{"job":{"components":{"2959332":{"id":2959332,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":352,"y":0,"width":32,"height":32,"inputConnectorIDs":[2959328],"outputSuccessConnectorIDs":[2959330],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"fixedlength to csv"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport json\nimport time\n#python function to call lambda to encrypt s3 file to send to galileo\n\nbody = json.dumps(dict(source_file='s3://aspiration-datateam/dump/jchen/galileo_snowflake/${galileo_filename}.out',\n                       target_file='s3://aspiration-datateam/dump/jchen/galileo_snowflake/${galileo_filename}.out.csv',\n                       column_format='1,6,1,50,20,4',\n                       ignore_header='1',\n                       ignore_trailer='1',\n                       trim_blanks=True\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:data-python-fixedwidth-converter',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n\n\nrun_lambda()\n\nprint ('wait 30 seconds for lambda function completion')\ntime.sleep(30)\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959333":{"id":2959333,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":256,"y":0,"width":32,"height":32,"inputConnectorIDs":[2959331],"outputSuccessConnectorIDs":[2959328],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"decrypt file"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\n#python function to call lambda to encrypt s3 file to send to galileo\nimport time\nimport json\n\ns3 = boto3.resource('s3')\n\nbody = json.dumps(dict(operation='dec',file='s3://aspiration-datateam/dump/jchen/galileo_snowflake/${galileo_filename}.out.gpg',\n                       decrypted_file_path='s3://aspiration-datateam/dump/jchen/galileo_snowflake',\n                       gpg_key='galileo_public_key',\n                       extension='gpg'\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:prod-python-encrypt-decrypt-manual',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n\n\nprint ('decrypt file:', 's3://aspiration-datateam/dump/jchen/galileo_snowflake/${galileo_filename}.out.gpg')\nrun_lambda()\n\nprint ('wait 30 seconds for lambda function completion')\ntime.sleep(30)\n\n# delete gpg file, otherwise the next step will fail\nprint ('deleting gpg file, otherwise the aws copy command will fail.')\ns3.Object('aspiration-datateam','dump/jchen/galileo_snowflake/${galileo_filename}.out.gpg').delete()\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959334":{"id":2959334,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":128,"y":0,"width":32,"height":32,"inputConnectorIDs":[2959348],"outputSuccessConnectorIDs":[2959331],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"get_response_file_from_galileo"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport botocore\nimport time\nimport json\n#python function to call lambda to retrieve file from galileo sftp\n\ns3 = boto3.resource('s3')\n\ns3_bucket_name = 'aspiration-datateam'\ns3_file_key = 'dump/jchen/galileo_snowflake/${galileo_filename}.out.gpg'\ns3_filename = 's3://' + s3_bucket_name + '/' + s3_file_key\n\n# delete file in s3\ns3.Object(s3_bucket_name, s3_file_key).delete()\n\nbody = json.dumps(dict(operation='get',working_dir='/sftpdir/response',\n                       s3_output=s3_filename,\n                       sftp_file_name='${galileo_filename}.out.gpg',\n                       lambda_arn='None'\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:sftp-to-s3-python',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n\nprint ('get response file to galileo:', s3_filename)\nrun_lambda()\n\nprint ('wait 30 seconds for aws lambda function completion')\ntime.sleep(30)\n\n# check file existance\ntry:\n    s3.Object(s3_bucket_name, s3_file_key).load()\nexcept botocore.exceptions.ClientError as e:\n    if e.response['Error']['Code'] == \"404\":\n        # The object does not exist.\n        print ('Error retrieving file from galileo: ', s3_filename)\n        raise e\n    else:\n        # Something else has gone wrong.\n        print ('Error retrieving file from galileo: ', s3_filename)\n        raise e\nelse:\n    # The object does exist.\n    print ('successfully retrieved file from galileo: ', s3_filename)\n    \n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959335":{"id":2959335,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2959348,2959349],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959336":{"id":2959336,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":0,"y":112,"width":32,"height":32,"inputConnectorIDs":[2959349],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"table creation"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists etl.galileo_transaction_batch_response_jchen;\ncreate table etl.galileo_transaction_batch_response_jchen\n  (\n    filename varchar(2000),\n    record_type char(1),\n    record_number varchar(6),\n    account_id_type char(1),\n    account_identifier varchar(50),\n    transaction_identifier varchar(20),\n    galileo_response_code varchar(4),\n    etl_load_date timestamptz default current_timestamp\n  );\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959338":{"id":2959338,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":464,"y":0,"width":32,"height":32,"inputConnectorIDs":[2959330],"outputSuccessConnectorIDs":[2959329],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"load to staging"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SET TIMEZONE = 'America/Los_Angeles';\n\ndrop table if exists etl.galileo_transaction_batch_response_staging_jchen;\ncreate table etl.galileo_transaction_batch_response_staging_jchen\n  (\n    record_type char(1),\n    record_number varchar(6),\n    account_id_type char(1),\n    account_identifier varchar(50),\n    transaction_identifier varchar(20),\n    galileo_response_code varchar(4)\n  );\n\n\ncopy into etl.galileo_transaction_batch_response_staging_jchen\n\tfrom @public.datateam/dump/jchen/galileo_snowflake/${galileo_filename}.out.csv\nfile_format = (type ='CSV'\n    field_DELIMITER = ','\n    ESCAPE = '\\\\'\n    FIELD_OPTIONALLY_ENCLOSED_BY = '\"'\n    )\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2959339":{"id":2959339,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":464,"y":112,"width":32,"height":32,"inputConnectorIDs":[2959329],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"load to main response table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"delete from etl.galileo_transaction_batch_response_jchen\nwhere 1=1\n  and filename='${galileo_filename}'\n;\n\ninsert into etl.galileo_transaction_batch_response_jchen\n(filename, record_type, record_number, account_id_type, account_identifier, transaction_identifier, galileo_response_code)\nselect\n    '${galileo_filename}',\n    record_type,\n    record_number,\n    account_id_type,\n    account_identifier,\n    transaction_identifier,\n    galileo_response_code\nfrom etl.galileo_transaction_batch_response_staging_jchen\nwhere record_type='D'\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2959328":{"id":2959328,"sourceID":2959333,"targetID":2959332},"2959329":{"id":2959329,"sourceID":2959338,"targetID":2959339},"2959330":{"id":2959330,"sourceID":2959332,"targetID":2959338},"2959331":{"id":2959331,"sourceID":2959334,"targetID":2959333}},"failureConnectors":{},"unconditionalConnectors":{"2959348":{"id":2959348,"sourceID":2959335,"targetID":2959334},"2959349":{"id":2959349,"sourceID":2959335,"targetID":2959336}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"galileo_filename":{"definition":{"name":"galileo_filename","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"btrans_584_20200803_ip008.txt"}},"grids":{}},"info":{"name":"Load_response_File_from_Galileo_jchen_2020_interest_files","description":"","type":"ORCHESTRATION","tag":"14c4815a-9d6d-4c7d-810f-17b06237838b"}}