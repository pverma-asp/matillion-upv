{"job":{"components":{"2960051":{"id":2960051,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-1904,"y":-80,"width":32,"height":32,"inputConnectorIDs":[2960078],"outputSuccessConnectorIDs":[2960079],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"encrypt_file"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\n#python function to call lambda to encrypt s3 file to send to galileo\n\nbody = json.dumps(dict(operation='enc',file='s3://aspiration-datateam/dump/sharris/${galileo_filename}.txt',\n                       encrypted_file_path='s3://aspiration-datateam/dump/sharris/',\n                       gpg_key='galileo_public_key',\n                       extension='gpg'\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:prod-python-encrypt-decrypt-manual',\n    InvocationType='RequestResponse',\n    LogType='Tail',\n    Payload=body\n    )\n    print(response['Payload'].read())\n\n\nrun_lambda()\n#{\n#   \"operation\": \"enc\",\n#   \"file\": \"s3://aspiration-datateam/dump/szhang/btrans_584_20200226_005.txt\",\n#   \"encrypted_file_path\": \"s3://aspiration-datateam/dump/szhang/\",\n#   \"gpg_key\": \"galileo_public_key\",\n#   \"extension\": \"gpg\"\n# }\n# s3://aspiration-datateam/dump/sharris/\n# s3://aspiration-datateam/dump/saida/unidays/to-galileo/\n# s3://aspiration-etl-staging/file_processing/galileo_batch_transactions/batch_files/"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2960054":{"id":2960054,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-2032,"y":-80,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2960078],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2960096":{"id":2960096,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-1792,"y":-80,"width":32,"height":32,"inputConnectorIDs":[2960079],"outputSuccessConnectorIDs":[2960077],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"send_file_to_galileo"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\n#python function to call lambda to encrypt s3 file to send to galileo\n\nbody = json.dumps(dict(operation='put',working_dir='/sftpdir/batch',\n                       s3_output='s3://aspiration-datateam/dump/saida/unidays/to-galileo/${galileo_filename}.txt.gpg',\n                       sftp_file_name='${galileo_filename}.txt.gpg',\n                       lambda_arn='None'\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:sftp-to-s3-python',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n\n    \nrun_lambda()\n\n\n# s3://aspiration-datateam/dump/sharris/\n# s3://aspiration-datateam/dump/saida/unidays/to-galileo/"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2960097":{"id":2960097,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-1437,"y":-82,"width":32,"height":32,"inputConnectorIDs":[2960098],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SQL Script 0"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists ush.output;\ncreate table ush.output\n(\n  output_row varchar(2000)\n);\n\n\n\n\nCOPY INTO ush.output (output_row)\nFROM (SELECT $1\n      FROM @public.datateam/dump/saida/unidays/from-galileo/${galileo_filename}.txt.out)\nFILE_FORMAT = ETL.PLAIN_TEXT\nON_ERROR = SKIP_FILE;\n\n--remove header and trailer\ndelete from ush.output \nwhere left(output_row,1) in ('H','T');\n\n/*\n--account change\ndrop table if exists ush.bas_352_account_change_output_reissue;\ncreate table ush.bas_352_account_change_output_reissue as\n  select\n    substring(output_row,1,1) as record_type,\n    substring(output_row,2,6) as record_number,\n    substring(output_row,8,1) as account_id_type,\n    trim(substring(output_row,9,50)) as account_identifier,\n    trim(substring(output_row,59,4)) as galileo_response_code\n  from ush.output;\n\n\n--transaction\ndrop table if exists ush.data_128_output;\ncreate table ush.data_128_output as\n  select\n    substring(output_row,1,1) as record_type,\n    substring(output_row,2,6) as record_number,\n    substring(output_row,8,1) as account_id_type,\n    substring(output_row,9,50) as account_identifier,\n    substring(output_row,59,20) as transaction_identifier,\n    substring(output_row,79,4) as galileo_response_code\n  from ush.output;\n*/\n\ngrant select on all tables in schema ush to data_engineering_group;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2960099":{"id":2960099,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-1664,"y":-80,"width":32,"height":32,"inputConnectorIDs":[2960077],"outputSuccessConnectorIDs":[2960076],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"get_galileo_response_file"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\n\n\nbody = json.dumps(dict(operation='get',working_dir='/sftpdir/response',\n                       s3_output='s3://aspiration-datateam/dump/saida/unidays/from-galileo/${galileo_filename}.txt.out.gpg',\n                       sftp_file_name='${galileo_filename}.txt.out.gpg',\n                       lambda_arn='none'\n                      ))\n\nprint (body)\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:sftp-to-s3-python',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n    \nrun_lambda()    \n\n\n\n# s3://aspiration-datateam/dump/sharris/\n# s3://aspiration-datateam/dump/saida/unidays/to-galileo/"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2960100":{"id":2960100,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-1536,"y":-80,"width":32,"height":32,"inputConnectorIDs":[2960076],"outputSuccessConnectorIDs":[2960098],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"decrypt_file"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\n#python function to call lambda to encrypt s3 file to send to galileo\nimport time\nimport json\n\ns3 = boto3.resource('s3')\n\nbody = json.dumps(dict(operation='dec',file='s3://aspiration-datateam/dump/saida/Aspiration_Financial_outcome_cf_08062022081014_to_09062022081013.csv.pgp',\n                       decrypted_file_path='s3://aspiration-datateam/dump/saida',\n                       gpg_key='galileo_public_key',\n                       extension='pgp'\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:prod-python-encrypt-decrypt-manual',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n\n\nrun_lambda()\n\n# s3://aspiration-datateam/dump/sharris/\n# s3://aspiration-datateam/dump/saida/unidays/to-galileo/\n\n\n\n\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2960076":{"id":2960076,"sourceID":2960099,"targetID":2960100},"2960077":{"id":2960077,"sourceID":2960096,"targetID":2960099},"2960079":{"id":2960079,"sourceID":2960051,"targetID":2960096},"2960098":{"id":2960098,"sourceID":2960100,"targetID":2960097}},"failureConnectors":{},"unconditionalConnectors":{"2960078":{"id":2960078,"sourceID":2960054,"targetID":2960051}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"galileo_filename":{"definition":{"name":"galileo_filename","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"Aspiration_Financial_outcome_cd_07062022081018_to_08062022081014"}},"grids":{"file_dates":{"definition":{"name":"file_dates","scope":"BRANCH","definitions":[{"name":"current_max_day","type":"TEXT"}],"description":"","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"move_files_s3_to_galileo_sftp","description":"","type":"ORCHESTRATION","tag":"2f47af3d-b77f-49cf-a33c-70a37fad757e"}}