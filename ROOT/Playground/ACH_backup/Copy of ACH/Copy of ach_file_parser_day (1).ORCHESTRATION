{"job":{"components":{"2958316":{"id":2958316,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-976,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2958315],"outputSuccessConnectorIDs":[2958313],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Python Script 0"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport re\nimport tempfile\nimport datetime\nimport os\nfrom urllib.parse import urlparse\n\ndef addNewLine(filePath, every, delimiter):\n    #Make sure to add the escape if you are using a special character ex: \\n\n    #Provide full file path and # of characters before inserting \\n character\n    #create temporary file read/write\n    temp = tempfile.NamedTemporaryFile(mode=\"r+\")\n    print(filePath)\n\n    #Open input file read-only\n    inputFile = open(filePath, 'r')\n    inputFileBytes = open(filePath,'rb')\n\n    #copy input file to temporary file, modifying as we go\n    try:\n        for words in inputFile:\n            temp.write(re.sub(\"(.{})\".format({every}), \"\\\\1{}\".format(delimiter), words, 0, re.DOTALL))\n    except UnicodeDecodeError:\n        for words in inputFileBytes:\n            temp.write(re.sub(\"(.{})\".format({every}), \"\\\\1{}\".format(delimiter), words.decode('latin1'), 0, re.DOTALL))\n    \n    \n    inputFile.close() #close inputfile\n\n    temp.seek(0) #Rewind temporary file to beginning\n\t\n    o = open(filePath, 'w') #Reopen input file writeable\n\n    #overwrite original file with temporary file contents\n    for line in temp:\n        try:\n            o.write(line)\n        except UnicodeDecodeError:\n            line = bytearray(line,encoding='utf-8')\n            o.write(line.decode())\n    \n    temp.close() #close temporary file and it will be deleted\n\ndef s3Credentials():\n    s3 = boto3.client('s3')\n    return s3\n\ndef downloadFromS3(s3,bucket,key):\n    paginator = s3.get_paginator('list_objects')\n    pages = paginator.paginate(Bucket=bucket, Prefix=key)\n    files_downloaded = []\n    for page in pages:\n        for obj in page['Contents']:\n            if re.findall(r'(?!.*pgp)ACH_${current_year}${current_month}${current_day}_?(\\w|\\W)?.(ACH|ach)?', obj['Key']):\n                path,filename = os.path.split(obj['Key'])\n                s3.download_file(bucket,obj['Key'],filename)\n                files_downloaded.append(filename)\n    return files_downloaded\n\ndef UploadToS3(s3, filename, bucket, key):\n    \"\"\"Uploads file to S3\n    Bucket is the main bucket\n    Key is the path where you want the file to be uploaded to\n    Ex bucket=bucket-name\n    key=foo/bucket/folder\"\"\"\n    s3.upload_file(filename,bucket,key)\n\ndef getBucketAndKeyS3(s3url):\n    bucket_path = urlparse(s3url)\n    return bucket_path.netloc, bucket_path.path.lstrip('/')\n  \ndef update_grid_variables(list_of_items, grid_variable_name):\n    new_list = [[items] for items in list_of_items]\n    context.updateGridVariable(grid_variable_name, new_list)\n  \n    \n\nif __name__ == \"__main__\":\n    creds = s3Credentials()\n    #Matillion job variables\n    file_bucket,file_key = getBucketAndKeyS3('${parsed_file_path}')\n    downloaded_file_names = downloadFromS3(creds, file_bucket,file_key)\n    print(downloaded_file_names)\n    update_grid_variables(downloaded_file_names, 'file_name_list')\n    for files_names in downloaded_file_names:\n        addNewLine(files_names, 94, '\\n')\n        UploadToS3(creds, files_names, file_bucket,os.path.join(file_key,files_names))\n        os.remove(files_names)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958317":{"id":2958317,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-496,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2958312],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update RAW ACH table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"delete from rdl.raw_ach_data\nwhere file_date = '${current_year}-${current_month}-${current_day}'\n;\n\ninsert into rdl.raw_ach_data(file_date, transaction_code, receiving_dfi_identification, check_digit, dfi_account_number, amount, individual_identification_number__identification_number__check_serial_number, individual_name__receiving_company_name, discretionary_data__payment_type_code__card_transaction_type_code, addenda_record_indicator, trace_number)\nselect '${current_year}-${current_month}-${current_day}', transaction_code, receiving_dfi_identification, check_digit, dfi_account_number, amount, individual_identification_number__identification_number__check_serial_number, individual_name__receiving_company_name, discretionary_data__payment_type_code__card_transaction_type_code, addenda_record_indicator, trace_number\nfrom etl.ach_entry_detail_staging\n;\n\n\n\ndelete from rdl.ach_addenda_record\nwhere file_date = '${current_year}-${current_month}-${current_day}'\n;\n\ninsert into rdl.ach_addenda_record(file_date,addenda_type_code,payment_related_information,addenda_sequence_number,entry_detail_sequence_number)\nselect '${current_year}-${current_month}-${current_day}', addenda_type_code,payment_related_information,addenda_sequence_number,entry_detail_sequence_number\nfrom etl.ach_addenda_record_staging\n;\n\n\ndelete from rdl.ach_batch_header\nwhere file_date = '${current_year}-${current_month}-${current_day}'\n;\n\ninsert into rdl.ach_batch_header(file_date,service_class_code, company_name, company_discretionary_data, company_identification, standard_entry_class_code, company_entry_description, company_descriptive_date, effective_entry_date, settlement_date_julian, originator_status_code, originating_dfi_identification, batch_number)\nselect '${current_year}-${current_month}-${current_day}', service_class_code, company_name, company_discretionary_data, company_identification, standard_entry_class_code, company_entry_description, company_descriptive_date, effective_entry_date, settlement_date_julian, originator_status_code, originating_dfi_identification, batch_number\nfrom etl.ach_batch_header_staging\n;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958336":{"id":2958336,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":237373210,"x":-1120,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2958314],"outputSuccessConnectorIDs":[2958315],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate ACH tables"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958337":{"id":2958337,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":773867971,"x":-848,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2958313],"outputSuccessConnectorIDs":[2958318],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"S3 Load ACH file"}}}},"visible":true},"4":{"slot":4,"name":"S3 Object Prefix","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ACH_${current_year}${current_month}${current_day}"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"8":{"slot":8,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${file_staging_table_name}"}}}},"visible":true},"9":{"slot":9,"name":"Load Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"record_type"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"ach_data"}}}},"visible":true},"23":{"slot":23,"name":"Date Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"auto"}}}},"visible":true},"24":{"slot":24,"name":"Time Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"auto"}}}},"visible":true},"26":{"slot":26,"name":"","elements":{},"visible":false},"27":{"slot":27,"name":"Escape","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958338":{"id":2958338,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-608,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2958319],"outputSuccessConnectorIDs":[2958312],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Load file sections"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"copy ${staging_schema}.ach_file_header_staging(priority_code, immediate_destination, immediate_origin, file_creation_date, file_creation_time, file_id_modifier, record_size, blocking_factor, format_code, immediate_destination_name, immediate_origin_name, reference_code)\nfrom '${file_staging_path}/ach_file_header.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'priority_code:2,immediate_destination:10,immediate_origin:10,file_creation_date:6,file_creation_time:4,file_id_modifier:1,record_size:3,blocking_factor:2,format_code:1,immediate_destination_name:23,immediate_origin_name:23,reference_code:8'\n;\n\ncopy ${staging_schema}.ach_batch_header_staging(service_class_code, company_name, company_discretionary_data, company_identification, standard_entry_class_code, company_entry_description, company_descriptive_date, effective_entry_date, settlement_date_julian, originator_status_code, originating_dfi_identification, batch_number)\nfrom '${file_staging_path}/ach_batch_header.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'service_class_code:3,company_name:16,company_discretionary_data:20,company_identification:10,standard_entry_class_code:3,company_entry_description:10,company_descriptive_date:6,effective_entry_date:6,settlement_date_julian:3,originator_status_code:1,originating_dfi_identification:8,batch_number:7'\n;\n\ncopy ${staging_schema}.ach_entry_detail_staging(transaction_code, receiving_dfi_identification, check_digit, dfi_account_number, amount, individual_identification_number__identification_number__check_serial_number, individual_name__receiving_company_name, discretionary_data__payment_type_code__card_transaction_type_code, addenda_record_indicator, trace_number)\nfrom '${file_staging_path}/ach_entry_detail.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'transaction_code:2,receiving_dfi_identification:8,check_digit:1,dfi_account_number:17,amount:10,individual_identification_number__identification_number__check_serial_number:15,individual_name__receiving_company_name:22,discretionary_data__payment_type_code__card_transaction_type_code:2,addenda_record_indicator:1,trace_number:15'\n;\n\ncopy ${staging_schema}.ach_addenda_record_staging(addenda_type_code,payment_related_information,addenda_sequence_number,entry_detail_sequence_number)\nfrom '${file_staging_path}/ach_addenda_record.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'addenda_type_code:2,payment_related_information:80,addenda_sequence_number:4,entry_detail_sequence_number:7,'\n;\n\ncopy ${staging_schema}.ach_batch_control_staging(service_class_code, entry__addenda_count, entry_hash, total_debit_entry_dollar_amount_in_batch, total_credit_entry_dollar_amount_in_batch, company_identification, message_authentication_code, reserved, originating_dfi_identification, batch_number)\nfrom '${file_staging_path}/ach_batch_control.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'service_class_code:3,entry__addenda_count:6,entry_hash:10,total_debit_entry_dollar_amount_in_batch:12,total_credit_entry_dollar_amount_in_batch:12,company_identification:10,message_authentication_code:19,reserved:6,originating_dfi_identification:8,batch_number:7'\n;\n\ncopy ${staging_schema}.ach_file_control_staging(batch_count, block_count, entry__addenda_count, entry_hash, total_debit_entry_dollar_amount_in_file, total_credit_entry_dollar_amount_in_file, reserved)\nfrom '${file_staging_path}/ach_file_control.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'batch_count:6,block_count:6,entry__addenda_count:8,entry_hash:10,total_debit_entry_dollar_amount_in_file:12,total_credit_entry_dollar_amount_in_file:12,reserved:39'\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958339":{"id":2958339,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-720,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2958318],"outputSuccessConnectorIDs":[2958319],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Unload file sections"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"unload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''1''')\nto '${file_staging_path}/ach_file_header.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''5''')\nto '${file_staging_path}/ach_batch_header.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''6''')\nto '${file_staging_path}/ach_entry_detail.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''7''')\nto '${file_staging_path}/ach_addenda_record.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''8''')\nto '${file_staging_path}/ach_batch_control.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''9'' and ach_data != replicate(''9'', 93)')\nto '${file_staging_path}/ach_file_control.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958342":{"id":2958342,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-1232,"y":-48,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2958314],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2958312":{"id":2958312,"sourceID":2958338,"targetID":2958317},"2958313":{"id":2958313,"sourceID":2958316,"targetID":2958337},"2958315":{"id":2958315,"sourceID":2958336,"targetID":2958316},"2958318":{"id":2958318,"sourceID":2958337,"targetID":2958339},"2958319":{"id":2958319,"sourceID":2958339,"targetID":2958338}},"failureConnectors":{},"unconditionalConnectors":{"2958314":{"id":2958314,"sourceID":2958342,"targetID":2958336}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"current_day":{"definition":{"name":"current_day","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"26"},"current_month":{"definition":{"name":"current_month","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"06"},"current_year":{"definition":{"name":"current_year","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"2018"},"file_staging_path":{"definition":{"name":"file_staging_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"s3://aspiration-etl-staging/file_processing/ach"},"file_staging_table_name":{"definition":{"name":"file_staging_table_name","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"ach_file_staging"},"parsed_file_path":{"definition":{"name":"parsed_file_path","type":"TEXT","scope":"BRANCH","description":"Where python will download the decrypted file and upload the split lined file\n","visibility":"PUBLIC"},"value":"s3://aspiration-etl-staging/file_processing/ach/coastal_file_drop"},"s3_file_path":{"definition":{"name":"s3_file_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"2018/11"},"s3_filename":{"definition":{"name":"s3_filename","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"test_20181112.csv"}},"grids":{"ach_table_list":{"definition":{"name":"ach_table_list","scope":"BRANCH","definitions":[{"name":"table_name","type":"TEXT"}],"description":"","visibility":"PUBLIC"},"values":[{"values":["ach_file_staging"]},{"values":["ach_file_header_staging"]},{"values":["ach_batch_header_staging"]},{"values":["ach_entry_detail_staging"]},{"values":["ach_batch_control_staging"]},{"values":["ach_file_control_staging"]}]},"file_name_list":{"definition":{"name":"file_name_list","scope":"BRANCH","definitions":[{"name":"file_names","type":"TEXT"}],"description":"list of file names","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"Copy of ach_file_parser_day (1)","description":"","type":"ORCHESTRATION","tag":"ffd61034-4591-497b-9dbd-71276388e608"}}