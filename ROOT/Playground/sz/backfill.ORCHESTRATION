{"job":{"components":{"2958240":{"id":2958240,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"ITERATE","implementationID":-424773870,"x":-240,"y":80,"width":32,"height":16,"inputConnectorIDs":[2958242],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Grid Iterator 0"}}}},"visible":true},"3":{"slot":3,"name":"Grid Variable","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"To_execute"}}}},"visible":true},"4":{"slot":4,"name":"Grid Variable Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Job"},"2":{"slot":2,"type":"STRING","value":"cur_date"}}}},"visible":true},"5":{"slot":5,"name":"Break on Failure","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":true},"6":{"slot":6,"name":"Concurrency","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Sequential"}}}},"visible":true},"999":{"slot":999,"name":"Record Values In Task History","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Yes"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[2958221],"inputIterationConnectorIDs":[]},"2958241":{"id":2958241,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-384,"y":80,"width":32,"height":32,"inputConnectorIDs":[2958243],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2958242],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Execution List"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import datetime\n\nexeclist = []\nstart = datetime.datetime(2020,1,1)\nend = datetime.datetime(2020,2,25)\n\nwhile start <= end:\n    execlist.append([str(start.date())])\n    start += datetime.timedelta(days=1)\n    \ncontext.updateGridVariable('To_execute', execlist)\nprint ('Execution list:')\nprint (To_execute)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958246":{"id":2958246,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-240,"y":112,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Execution prev day"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"SET timezone TO 'America/Los_Angeles';\n\ndelete from edw.interchange_revenue\nwhere date::date = '${cur_date}'\n;\n\nINSERT INTO edw.interchange_revenue(execution,\n                                    User_id,\n                                    Account_id,\n                                    Depository_id,\n                                    Investment_id,\n                                    Account_type,\n                            \t\tProduct_type,\n                                    Non_customer,\n                                    Category,\n                                    Item,\n                                    Date,\n                                    Value,\n                                    Value_type)\n\nWITH required_accounts AS (\n        SELECT uau.user_id AS User_id,\n               acc.id AS Account_id,\n               dep.id AS dep_id,\n               acc.product_type AS Account_product_type_id,\n               dep.product_id AS Account_product_id\n        FROM web_db.depository AS dep\n                 INNER JOIN web_db.account AS acc ON dep.account_id = acc.id\n                 INNER JOIN edw.view_unique_user_accounts uau ON uau.account_id = acc.id\n        WHERE acc.product_type = 2\n          AND dep.product_id IN (3, 4, 5)\n    ),\n\n     interchange_positive_by_dep_id_for_yesterday AS (\n         SELECT pt.depository_id AS dep_id,\n                SUM(gpt.interchange_fee_amount::float) AS yesterday_sum_interchange_positive\n         FROM web_db.galileo_posted_transaction as gpt\n            INNER JOIN web_db.posted_transaction as pt ON gpt.posted_transaction_id = pt.id\n         WHERE pt.post_date::date = '${cur_date}'::date\n            AND gpt.interchange_fee_amount::float > 0\n         GROUP BY dep_id\n     )\n\n\nSELECT getdate() AS execution,\n       ra.User_id AS User_id,\n       ra.Account_id AS Account_id,\n       ra.dep_id AS Depository_id,\n       NULL AS Investment_id,\n       (CASE\n          WHEN ra.Account_product_type_id = 2 THEN 'Depository'::text\n          ELSE ''::text\n         END) AS Account_type,\n       (CASE\n          WHEN ra.Account_product_id = 3 THEN 'Summit'::text\n          WHEN ra.Account_product_id = 4 THEN 'Spend'::text\n          WHEN ra.Account_product_id = 5 THEN 'Save'::text\n          ELSE ''::text\n         END) AS Product_type,\n        FALSE AS Non_customer,\n        'Direct'::text AS Category,\n        'Interchange Revenue'::text AS Item,\n        '${cur_date}'::date AS Date,\n        COALESCE(ip.yesterday_sum_interchange_positive, 0) AS Value,\n        'Revenue'::text AS Value_type\nFROM interchange_positive_by_dep_id_for_yesterday as ip\nINNER JOIN required_accounts as ra ON ip.dep_id = ra.dep_id\n;\n\n\n-- Delete existing data\nDELETE FROM edw.consolidated_pnl\nWHERE Item = 'Interchange Revenue'\n\tand cast(date as date) = '${cur_date}'\n;\n\n-- Insert updated data\n\nINSERT INTO edw.consolidated_pnl(execution,\n                                 User_id,\n                                 Account_id,\n                                 Depository_id,\n                                 Investment_id,\n                                 Account_type,\n                                 Product_type,\n                                 Non_customer,\n                                 Category,\n                                 Item,\n                                 Value_type,\n                                 Value,\n                                 Date)\nSELECT execution,\n       User_id,\n       Account_id,\n       Depository_id,\n       Investment_id,\n       Account_type,\n       Product_type,\n       Non_customer,\n       Category,\n       Item,\n       Value_type,\n       Value,\n       Date\nFROM edw.interchange_revenue\nwhere cast(date as date) = '${cur_date}';"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[2958221]},"2958247":{"id":2958247,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-480,"y":80,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2958243],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{},"unconditionalConnectors":{"2958242":{"id":2958242,"sourceID":2958241,"targetID":2958240},"2958243":{"id":2958243,"sourceID":2958247,"targetID":2958241}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{"2958221":{"id":2958221,"sourceID":2958240,"targetID":2958246}},"noteConnectors":{},"notes":{},"variables":{"cur_date":{"definition":{"name":"cur_date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"'2020-01-01'"}},"grids":{"To_execute":{"definition":{"name":"To_execute","scope":"BRANCH","definitions":[{"name":"Job","type":"TEXT"}],"description":"","visibility":"PUBLIC"},"values":[]}}},"info":{"name":"backfill","description":null,"type":"ORCHESTRATION","tag":"1533c6c3-0db5-489b-8f24-94b603a90b2c"}}