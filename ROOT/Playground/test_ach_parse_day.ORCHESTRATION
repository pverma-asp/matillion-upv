{"job":{"components":{"2957176":{"id":2957176,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-148,"y":-52,"width":32,"height":32,"inputConnectorIDs":[2957175],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Update RAW ACH table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"delete from rdl.raw_ach_data\nwhere file_date = '${current_year}-${current_month}-${current_day}'\n;\n\ninsert into rdl.raw_ach_data(file_date, transaction_code, receiving_dfi_identification, check_digit, dfi_account_number, amount, individual_identification_number__identification_number__check_serial_number, individual_name__receiving_company_name, discretionary_data__payment_type_code__card_transaction_type_code, addenda_record_indicator, trace_number)\nselect '${current_year}-${current_month}-${current_day}', transaction_code, receiving_dfi_identification, check_digit, dfi_account_number, amount, individual_identification_number__identification_number__check_serial_number, individual_name__receiving_company_name, discretionary_data__payment_type_code__card_transaction_type_code, addenda_record_indicator, trace_number\nfrom etl.ach_entry_detail_staging\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957177":{"id":2957177,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-254,"y":-46,"width":32,"height":32,"inputConnectorIDs":[2957172],"outputSuccessConnectorIDs":[2957175],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Load file sections"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"copy ${staging_schema}.ach_file_header_staging(priority_code, immediate_destination, immediate_origin, file_creation_date, file_creation_time, file_id_modifier, record_size, blocking_factor, format_code, immediate_destination_name, immediate_origin_name, reference_code)\nfrom '${file_staging_path}/ach_file_header.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'priority_code:2,immediate_destination:10,immediate_origin:10,file_creation_date:6,file_creation_time:4,file_id_modifier:1,record_size:3,blocking_factor:2,format_code:1,immediate_destination_name:23,immediate_origin_name:23,reference_code:8'\n;\n\ncopy ${staging_schema}.ach_batch_header_staging(service_class_code, company_name, company_discretionary_data, company_identification, standard_entry_class_code, company_entry_description, company_descriptive_date, effective_entry_date, settlement_date_julian, originator_status_code, originating_dfi_identification, batch_number)\nfrom '${file_staging_path}/ach_batch_header.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'service_class_code:3,company_name:16,company_discretionary_data:20,company_identification:10,standard_entry_class_code:3,company_entry_description:10,company_descriptive_date:6,effective_entry_date:6,settlement_date_julian:3,originator_status_code:1,originating_dfi_identification:8,batch_number:7'\n;\n\ncopy ${staging_schema}.ach_entry_detail_staging(transaction_code, receiving_dfi_identification, check_digit, dfi_account_number, amount, individual_identification_number__identification_number__check_serial_number, individual_name__receiving_company_name, discretionary_data__payment_type_code__card_transaction_type_code, addenda_record_indicator, trace_number)\nfrom '${file_staging_path}/ach_entry_detail.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'transaction_code:2,receiving_dfi_identification:8,check_digit:1,dfi_account_number:17,amount:10,individual_identification_number__identification_number__check_serial_number:15,individual_name__receiving_company_name:22,discretionary_data__payment_type_code__card_transaction_type_code:2,addenda_record_indicator:1,trace_number:15'\n;\n\ncopy ${staging_schema}.ach_batch_control_staging(service_class_code, entry__addenda_count, entry_hash, total_debit_entry_dollar_amount_in_batch, total_credit_entry_dollar_amount_in_batch, company_identification, message_authentication_code, reserved, originating_dfi_identification, batch_number)\nfrom '${file_staging_path}/ach_batch_control.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'service_class_code:3,entry__addenda_count:6,entry_hash:10,total_debit_entry_dollar_amount_in_batch:12,total_credit_entry_dollar_amount_in_batch:12,company_identification:10,message_authentication_code:19,reserved:6,originating_dfi_identification:8,batch_number:7'\n;\n\ncopy ${staging_schema}.ach_file_control_staging(batch_count, block_count, entry__addenda_count, entry_hash, total_debit_entry_dollar_amount_in_file, total_credit_entry_dollar_amount_in_file, reserved)\nfrom '${file_staging_path}/ach_file_control.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nfixedwidth 'batch_count:6,block_count:6,entry__addenda_count:8,entry_hash:10,total_debit_entry_dollar_amount_in_file:12,total_credit_entry_dollar_amount_in_file:12,reserved:39'\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957179":{"id":2957179,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-736,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2957174],"outputSuccessConnectorIDs":[2957173],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of Python Script 0"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport re\nimport tempfile\nimport datetime\nimport os\n\nstringTime = datetime.datetime.now().strftime('%Y%m%d')\nyesterday = (datetime.datetime.today() - datetime.timedelta(days=1)).strftime('%Y%m%d')\n\ndef addNewLine(filePath, every, delimiter):\n    #Make sure to add the escape if you are using a special character ex: \\n\n    #Provide full file path and # of characters before inserting \\n character\n    #create temporary file read/write\n    temp = tempfile.NamedTemporaryFile(mode=\"r+\")\n    print(filePath)\n\n    #Open input file read-only\n    inputFile = open(filePath, 'r')\n    inputFileBytes = open(filePath,'rb')\n\n    #copy input file to temporary file, modifying as we go\n    try:\n        for words in inputFile:\n            temp.write(re.sub(\"(.{})\".format({every}), \"\\\\1{}\".format(delimiter), words, 0, re.DOTALL))\n    except UnicodeDecodeError:\n        for words in inputFileBytes:\n            temp.write(re.sub(\"(.{})\".format({every}), \"\\\\1{}\".format(delimiter), words.decode('latin1'), 0, re.DOTALL))\n    \n    \n    inputFile.close() #close inputfile\n\n    temp.seek(0) #Rewind temporary file to beginning\n\t\n    o = open(filePath, 'w') #Reopen input file writeable\n\n    #overwrite original file with temporary file contents\n    for line in temp:\n        try:\n            o.write(line)\n        except UnicodeDecodeError:\n            line = bytearray(line,encoding='utf-8')\n            o.write(line.decode())\n    \n    temp.close() #close temporary file and it will be deleted\n\ndef s3Credentials():\n    s3 = boto3.client('s3')\n    return s3\n\ndef downloadFromS3(s3, bucket,key):\n    files_downloaded = []\n    for objects in s3.list_objects(Bucket=bucket, Prefix=key)['Contents']:\n        if re.findall(r'ACH_${current_year}${current_month}${current_day}_?(\\w|\\W)?.(ACH|ach)?', objects['Key']):\n            path,filename = os.path.split(objects['Key'])\n            s3.download_file(bucket,objects['Key'],filename)\n            files_downloaded.append(filename)\n    return files_downloaded\n\ndef UploadToS3(s3, filename, bucket, key):\n    \"\"\"Uploads file to S3\n    Bucket is the main bucket\n    Key is the path where you want the file to be uploaded to\n    Ex bucket=bucket-name\n    key=foo/bucket/folder\"\"\"\n    s3.upload_file(filename,bucket,key)\n\n\nif __name__ == \"__main__\":\n    creds = s3Credentials()\n    bucket = 'aspiration-datateam'\n    key = 'dump/dcarabadjac/ach/src'\n    downloaded_file_names = downloadFromS3(creds, bucket, key)\n    for files_names in downloaded_file_names:\n        addNewLine(files_names, 94, '\\n')\n        UploadToS3(creds, files_names, bucket, 'dump/dcarabadjac/ach/parsed/'+files_names)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957180":{"id":2957180,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":773867971,"x":-560,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2957173],"outputSuccessConnectorIDs":[2957178],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"S3 Load ACH file"}}}},"visible":true},"4":{"slot":4,"name":"S3 Object Prefix","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"ACH_${current_year}${current_month}${current_day}"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":true},"8":{"slot":8,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${file_staging_table_name}"}}}},"visible":true},"9":{"slot":9,"name":"Load Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"record_type"}}},"2":{"slot":2,"values":{"1":{"slot":1,"type":"STRING","value":"ach_data"}}}},"visible":true},"23":{"slot":23,"name":"Date Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"auto"}}}},"visible":true},"24":{"slot":24,"name":"Time Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"auto"}}}},"visible":true},"26":{"slot":26,"name":"","elements":{},"visible":false},"27":{"slot":27,"name":"Escape","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957181":{"id":2957181,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-1232,"y":-48,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2957169],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957182":{"id":2957182,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-362,"y":-49,"width":32,"height":32,"inputConnectorIDs":[2957178],"outputSuccessConnectorIDs":[2957172],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Unload file sections"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"unload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''1''')\nto '${file_staging_path}/ach_file_header.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''5''')\nto '${file_staging_path}/ach_batch_header.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''6''')\nto '${file_staging_path}/ach_entry_detail.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''8''')\nto '${file_staging_path}/ach_batch_control.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n\nunload ('select ach_data from ${staging_schema}.${file_staging_table_name} where record_type = ''9'' and ach_data != replicate(''9'', 93)')\nto '${file_staging_path}/ach_file_control.ach'\niam_role 'arn:aws:iam::332894900161:role/RedshiftClusterRole'\nENCRYPTED\nKMS_KEY_ID '${kms_key_id}'\nparallel off\nallowoverwrite\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957183":{"id":2957183,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":237373210,"x":-976,"y":-48,"width":32,"height":32,"inputConnectorIDs":[2957169],"outputSuccessConnectorIDs":[2957174],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Truncate ACH tables"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2957172":{"id":2957172,"sourceID":2957182,"targetID":2957177},"2957173":{"id":2957173,"sourceID":2957179,"targetID":2957180},"2957174":{"id":2957174,"sourceID":2957183,"targetID":2957179},"2957175":{"id":2957175,"sourceID":2957177,"targetID":2957176},"2957178":{"id":2957178,"sourceID":2957180,"targetID":2957182}},"failureConnectors":{},"unconditionalConnectors":{"2957169":{"id":2957169,"sourceID":2957181,"targetID":2957183}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"current_day":{"definition":{"name":"current_day","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"06"},"current_month":{"definition":{"name":"current_month","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"03"},"current_year":{"definition":{"name":"current_year","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"2019"},"file_staging_path":{"definition":{"name":"file_staging_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"s3://aspiration-etl-staging/file_processing/ach"},"file_staging_table_name":{"definition":{"name":"file_staging_table_name","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"ach_file_staging3"},"s3_file_path":{"definition":{"name":"s3_file_path","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"2018/11"},"s3_filename":{"definition":{"name":"s3_filename","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"test_20181112.csv"}},"grids":{"ach_table_list":{"definition":{"name":"ach_table_list","scope":"BRANCH","definitions":[{"name":"table_name","type":"TEXT"}],"description":"","visibility":"PUBLIC"},"values":[{"values":["ach_file_staging"]},{"values":["ach_file_header_staging"]},{"values":["ach_batch_header_staging"]},{"values":["ach_entry_detail_staging"]},{"values":["ach_batch_control_staging"]},{"values":["ach_file_control_staging"]}]}}},"info":{"name":"test_ach_parse_day","description":"","type":"ORCHESTRATION","tag":"efd4b537-a3d0-443d-bcc8-5e7c6ed20923"}}