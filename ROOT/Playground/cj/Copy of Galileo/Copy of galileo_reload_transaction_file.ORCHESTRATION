{"job":{"components":{"2957648":{"id":2957648,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-480,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2957673],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957649":{"id":2957649,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":773867971,"x":-240,"y":0,"width":32,"height":32,"inputConnectorIDs":[2957677],"outputSuccessConnectorIDs":[2957678],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Load"}}}},"visible":true},"4":{"slot":4,"name":"S3 Object Prefix","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${input_filename}"}}}},"visible":true},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${staging_schema}"}}}},"visible":true},"8":{"slot":8,"name":"Target Table Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${staging_table}"}}}},"visible":true},"9":{"slot":9,"name":"Load Columns","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"raw_row_data"}}}},"visible":true},"23":{"slot":23,"name":"Date Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"auto"}}}},"visible":true},"24":{"slot":24,"name":"Time Format","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"auto"}}}},"visible":true},"26":{"slot":26,"name":"","elements":{},"visible":false},"27":{"slot":27,"name":"Escape","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"No"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957650":{"id":2957650,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-80,"y":0,"width":32,"height":32,"inputConnectorIDs":[2957679],"outputSuccessConnectorIDs":[2957676],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Cleanup"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DROP TABLE IF EXISTS ${staging_schema}.${staging_table};"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957696":{"id":2957696,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":-1946388514,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[2957676],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957697":{"id":2957697,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-400,"y":0,"width":32,"height":32,"inputConnectorIDs":[2957673],"outputSuccessConnectorIDs":[2957698],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Variables"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"###\n# Variables are directly accessible: \n#   print myvar\n# Updating a variable:\n#   context.updateVariable('myvar', 'new-value')\n# Grid Variables are accessible via the context:\n#   print context.getGridVariable('mygridvar')\n# Udating a grid variable:\n#   context.updateGridVariable('mygridvar', [['list','of'],['lists','!']])\n# A database cursor can be accessed from the context (Jython only):\n#   cursor = context.cursor()\n#   cursor.execute('select count(*) from mytable')\n#   rowcount = cursor.fetchone()[0]\n###\nimport datetime\n\n#add run_history_id to create a unique temp table for parrallel processing\ncontext.updateVariable(\"staging_table\", staging_table + str(run_history_id) + '_${file_number}')\n\n#add YYYYMMDD to batch_filename varible \n#add value in batch_filename_sequence variable\n#Note: date calc rolls to next day when processed after 5pm MT or 4pm PT (Galileo is no longer processing at this time)\n#context.updateVariable(\"batch_filename\", batch_filename + datetime.date.today().strftime('%Y') + datetime.date.today().strftime('%m') + datetime.date.today().strftime('%d') + str(run_history_id) + '.txt')"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957699":{"id":2957699,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-320,"y":0,"width":32,"height":32,"inputConnectorIDs":[2957698],"outputSuccessConnectorIDs":[2957677],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Stage"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DROP TABLE IF EXISTS ${staging_schema}.${staging_table};\nCREATE TABLE ${staging_schema}.${staging_table} (\n\trownum \t\t\t\t\tBIGINT IDENTITY(0,1),\n\traw_row_data\t \t\tVARCHAR(65535)\n\t);\nALTER TABLE ${staging_schema}.${staging_table}\n   OWNER TO svc_etl;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2957700":{"id":2957700,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-160,"y":0,"width":32,"height":32,"inputConnectorIDs":[2957678],"outputSuccessConnectorIDs":[2957679],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Store"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"INSERT INTO rdl.swagbucks_redemption\n\t(etl_run_history_id    \n\t,etl_timestamp         \n\t,etl_filename          \n\t,etl_rownum            \n\t,redemption_code       \n\t,batch_date            \n\t,distribution_amount   \n\t,order_id              \n\t,transaction_identifier)\nWITH\n\traw_row_data AS (\n      SELECT row_number() over(order by rownum asc)-1 AS rownum\n         , first_value(raw_row_data) over(order by rownum asc rows between unbounded preceding and unbounded following) AS raw_header_row\n         , raw_row_data AS raw_detail_row\n         , last_value(raw_row_data) over(order by rownum asc rows between unbounded preceding and unbounded following) AS raw_trailer_row\n      FROM ${staging_schema}.${staging_table}\n      GROUP BY rownum, raw_row_data\n      ORDER BY rownum ASC\n      ),\n   user_payment_accounts AS (\n\t  SELECT pa.redemption_code\n  \t\t , upa.account_number AS prn\n  \t\t , upa.user_id\n         , upa.account_type\n         , upa.is_deleted\n         , upa.is_admin_disabled\n         , row_number() over(partition by upa.user_id order by upa.account_type asc nulls last, upa.is_deleted asc, upa.is_admin_disabled asc) as rownum\n      FROM web_db.partnership_account pa\n      LEFT JOIN web_db.user_payment_account upa ON upa.user_id = pa.user_id AND upa.depository_id is not null\n\t  )  \nSELECT '${run_history_id}' \t\tAS ETL_RUN_HISTORY_ID\n\t , sysdate\t\t\t\t\tAS ETL_TIMESTAMP\n\t , '${input_filename}'\t\tAS ETL_FILENAME\n     , rownum\t\t\t\t\tAS ETL_ROWNUM\n     \n     , upa.redemption_code\n     , null\t\t\t\t\t\t\t\t--batch_date\n\t , substring(raw_detail_row,84,13)\t--D_TRANSACTION_AMOUNT\n     , null\t\t\t\t\t\t\t\t--order_id\n\t , substring(raw_detail_row,137,20)\t--D_TRANSACTION_IDENTIFIER\nFROM raw_row_data\nLEFT JOIN user_payment_accounts upa ON upa.prn = substring(raw_detail_row,9,50)\nWHERE raw_header_row <> raw_detail_row\n  AND raw_trailer_row <> raw_detail_row;\n  \nINSERT INTO rdl.galileo_batch_transaction \n\t(ETL_RUN_HISTORY_ID\n    ,ETL_TIMESTAMP\n    ,D_RECORD_TYPE\n   \t,D_RECORD_NUMBER\n   \t,D_ACCOUNT_ID_TYPE\n   \t,D_ACCOUNT_IDENTIFIER\n   \t,D_LOCATION_TYPE\n   \t,D_LOCATION_ID\n   \t,D_TRANSACTION_TYPE\n   \t,D_TRANSACTION_SUB_TYPE\n   \t,D_TRANSACTION_AMOUNT\n   \t,D_TRANSACTION_DESCRIPTION\n   \t,D_TRANSACTION_IDENTIFIER)\nWITH\n\traw_row_data AS (\n      SELECT row_number() over(order by rownum asc)-1 AS rownum\n         , first_value(raw_row_data) over(order by rownum asc rows between unbounded preceding and unbounded following) AS raw_header_row\n         , raw_row_data AS raw_detail_row\n         , last_value(raw_row_data) over(order by rownum asc rows between unbounded preceding and unbounded following) AS raw_trailer_row\n      FROM ${staging_schema}.${staging_table}\n      GROUP BY rownum, raw_row_data\n      ORDER BY rownum ASC\n      )\nSELECT '${run_history_id}' \tAS ETL_RUN_HISTORY_ID\n\t , sysdate\t\t\t\t\tAS ETL_TIMESTAMP\n     \n\t , substring(raw_detail_row,1,1)\t--D_RECORD_TYPE\n\t , substring(raw_detail_row,2,6)\t--D_RECORD_NUMBER\n\t , substring(raw_detail_row,8,1)\t--D_ACCOUNT_ID_TYPE\n\t , substring(raw_detail_row,9,50)\t--D_ACCOUNT_IDENTIFIER\n\t , substring(raw_detail_row,59,1)\t--D_LOCATION_ID\n\t , substring(raw_detail_row,60,20)\t--D_LOCATION_TYPE\n\t , substring(raw_detail_row,80,1)\t--D_TRANSACTION_TYPE\n\t , substring(raw_detail_row,81,3)\t--D_TRANSACTION_SUB_TYPE\n\t , substring(raw_detail_row,84,13)\t--D_TRANSACTION_AMOUNT\n\t , substring(raw_detail_row,97,40)\t--D_TRANSACTION_DESCRIPTION\n\t , substring(raw_detail_row,137,20)\t--D_TRANSACTION_IDENTIFIER\nFROM raw_row_data\nWHERE raw_header_row <> raw_detail_row\n  AND raw_trailer_row <> raw_detail_row;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2957676":{"id":2957676,"sourceID":2957650,"targetID":2957696},"2957677":{"id":2957677,"sourceID":2957699,"targetID":2957649},"2957678":{"id":2957678,"sourceID":2957649,"targetID":2957700},"2957679":{"id":2957679,"sourceID":2957700,"targetID":2957650},"2957698":{"id":2957698,"sourceID":2957697,"targetID":2957699}},"failureConnectors":{},"unconditionalConnectors":{"2957673":{"id":2957673,"sourceID":2957648,"targetID":2957697}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"file_number":{"definition":{"name":"file_number","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":""},"input_bucket":{"definition":{"name":"input_bucket","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"s3://aspiration-etl-staging/file_processing/galileo_batch_transactions/response_files"},"input_filename":{"definition":{"name":"input_filename","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":"passed_variable"},"staging_table":{"definition":{"name":"staging_table","type":"TEXT","scope":"BRANCH","description":"","visibility":"PRIVATE"},"value":"tmp_response"}},"grids":{}},"info":{"name":"Copy of galileo_reload_transaction_file","description":"","type":"ORCHESTRATION","tag":"6f5d482b-0201-4843-b607-9bcac653ed13"}}