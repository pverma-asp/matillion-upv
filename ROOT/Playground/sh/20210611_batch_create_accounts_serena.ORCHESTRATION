{"job":{"components":{"2958528":{"id":2958528,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":160,"y":176,"width":32,"height":32,"inputConnectorIDs":[2958550],"outputSuccessConnectorIDs":[2958545],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create galileo enrollment table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"UPDATE etl.galileo_enrollment_batch_header\nSET file_name = '${galileo_filename}.gpg',\n       file_transmit_date = '${file_transmit_date}'\nWHERE record_type = 'H'\n;\n\ndelete from etl.galileo_enrollment_batch_detail;\ninsert into ETL.GALILEO_ENROLLMENT_BATCH_DETAIL\n    (RECORD_TYPE, RECORD_NUMBER, PRODUCT_ID, PRIMARY_CARDHOLDER_FIRST_NAME, PRIMARY_CARDHOLDER_MIDDLE_NAME, PRIMARY_CARDHOLDER_LAST_NAME, ADDRESS_LINE_1, ADDRESS_LINE_2, CITY, STATE, ZIP_CODE, COUNTRY, PRIMARY_PHONE_NUMBER, SECONDARY_PHONE_NUMBER, EMAIL, ID_1_TYPE, ID_1_VALUE, ID_2_TYPE, ID_2_VALUE, DATE_OF_BIRTH, EXTERNAL_ID, EXPRESS_MAIL, LOAD_AMOUNT, LOAD_TYPE, LOAD_DESCRIPTION, HIT_ID, SOURCE, WEB_UID, WEB_PWD, SECRET_QUESTION, SECRET_ANSWER, MOBILE_PHONE_NUMBER, CARRIER_ID, EMBOSS_LINE_2)\n\nwith aplus_users as (\n    select ua.USER_ID\n--     distinct PLAN_ID\n    from WEB_DB.SUBSCRIPTION s\n             join WEB_DB.USER_ACCOUNT ua on s.ACCOUNT_ID = ua.ACCOUNT_ID\n    where 1 = 1\n      and plan_id ILIKE 'planet%protection%'\n      and status = 'active'\n)\n, pids as (\nselect\n    da.USER_ID,\n    da.INCEPTION_DATE::date as inception_date,\n    datediff('day', da.INCEPTION_DATE, current_date()) as days_since_inception,\n    ap.USER_ID is not null as is_aplus_user,\n    case\n        when ap.USER_ID is null and days_since_inception < 30 then 6540     -- non aplus\n        when ap.USER_ID is null and days_since_inception >=30 then 6635     -- non aplus\n        when ap.USER_ID is not null and days_since_inception < 30 then 6541 -- aplus\n        when ap.USER_ID is not null and days_since_inception >=30 then 6542 -- aplus\n    end as pid\nfrom bi.DT_ACCOUNTS da\n-- join etl.ATO_USERS_LIST_20210602 atou on da.USER_ID=atou.USER_ID\nleft join aplus_users ap on da.USER_ID=ap.USER_ID\nwhere 1=1\n  and ACCOUNT_TYPE='Checking'\n  and TERMINATION_DATE is null\n)\nselect\n--     pids.USER_ID,\n--     ue.EMAIL,\n    'D' as record_type\n    ,row_number() over (order by ue.USER_ID) as recordnumber\n    ,pids.pid::varchar as product_id\n    ,left(up.FIRST_NAME, 20)\n    ,left(COALESCE(up.MIDDLE_NAME, ''), 20)  -- can be null\n    ,left(up.LAST_NAME, 20)\n    ,left(a.STREET1, 30)\n    ,COALESCE(a.street2, '')  -- can be null\n    ,left(a.CITY, 20)\n    ,s.CODE\n    ,replace(a.ZIP_OR_POSTAL_CODE, '-', '')\n    ,'USA' as country\n    ,replace(up.PHONE_NUMBER, '-', '')\n    ,'' -- secondary phone number\n    ,ue.EMAIL\n    ,'2' -- ID 1 type\n    ,upsin.TAX_IDENTIFICATION_NUMBER -- sin number\n    ,'' -- ID 2 type\n    ,''\n    ,to_char(up.DATE_OF_BIRTH, 'MM/DD/YYYY')  -- date of birth\n    ,to_char(current_date(), 'YYYYMMDD') || '_' || to_char(current_time(), 'HH24MISS') || '_' || lpad(recordnumber, 6, '0') -- external id\n    ,case when pids.pid in (6541, 6542) then 'Y' else 'N' end  -- express mail\n    ,''  -- load amount\n    ,''  -- load type\n    ,''  -- load desc\n    ,''  -- hit id\n    ,''  -- source\n    ,''  -- web uid\n    ,''  -- web pwd\n    ,''  -- secret q\n    ,''  -- secret a\n    ,''  -- mobile phone\n    ,''  -- carrier id\n    ,''  -- emboss line 2\nfrom pids\njoin WEB_DB.user_profile up on pids.USER_ID=up.USER_ID\njoin WEB_DB.USER_EMAIL ue on up.USER_ID=ue.USER_ID and ue.IS_PRIMARY = true\njoin WEB_DB.ADDRESS a on up.ADDRESS_ID=a.id\njoin WEB_DB.STATE s on a.STATE_ID=s.ID\njoin PCI_STG.USER_PROFILE upsin on upsin.USER_ID=up.USER_ID\nwhere 1=1\n  and ue.user_id in (\n\n3500784\n,4015517\n\n\n    )\n;\n\n\n--trailer data\nUPDATE etl.galileo_enrollment_batch_trailer\n   SET \"count\" = (select count(*) from etl.galileo_enrollment_batch_detail)\nWHERE record_type = 'T';\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958530":{"id":2958530,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-112,"y":112,"width":32,"height":32,"inputConnectorIDs":[2958547],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of insert to history"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into etl.GALILEO_ENROLLMENT_BATCH_DETAIL_HISTORY\n    (FILENAME, RECORD_TYPE, RECORD_NUMBER, PRODUCT_ID, PRIMARY_CARDHOLDER_FIRST_NAME, PRIMARY_CARDHOLDER_MIDDLE_NAME, PRIMARY_CARDHOLDER_LAST_NAME, ADDRESS_LINE_1, ADDRESS_LINE_2, CITY, STATE, ZIP_CODE, COUNTRY, PRIMARY_PHONE_NUMBER, SECONDARY_PHONE_NUMBER, EMAIL, ID_1_TYPE, ID_1_VALUE, ID_2_TYPE, ID_2_VALUE, DATE_OF_BIRTH, EXTERNAL_ID, EXPRESS_MAIL, LOAD_AMOUNT, LOAD_TYPE, LOAD_DESCRIPTION, HIT_ID, SOURCE, WEB_UID, WEB_PWD, SECRET_QUESTION, SECRET_ANSWER, MOBILE_PHONE_NUMBER, CARRIER_ID, EMBOSS_LINE_2)\nselect\n    '${galileo_filename}', record_type, record_number, product_id, primary_cardholder_first_name, primary_cardholder_middle_name, primary_cardholder_last_name, address_line_1, address_line_2, city, state, zip_code, country, primary_phone_number, secondary_phone_number, email, id_1_type, '*********', id_2_type, id_2_value, date_of_birth, external_id, express_mail, load_amount, load_type, load_description, hit_id, source, web_uid, web_pwd, secret_question, secret_answer, mobile_phone_number, carrier_id, emboss_line_2\nfrom etl.GALILEO_ENROLLMENT_BATCH_DETAIL\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958531":{"id":2958531,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2958544,2958547],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958548":{"id":2958548,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":128,"y":64,"width":32,"height":32,"inputConnectorIDs":[2958544],"outputSuccessConnectorIDs":[2958550],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"not used"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"update\n etl.GALILEO_ENROLLMENT_BATCH_DETAIL_HISTORY\n set filename='benroll_584_20210610_001.txt'\nwhere 1=1\n  and FILENAME='benroll_584_20210610_001.txt.txt'\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2958549":{"id":2958549,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1785813072,"x":160,"y":288,"width":32,"height":32,"inputConnectorIDs":[2958545],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send_BEnrollment_File_to_Galileo 0"}}}},"visible":true},"2":{"slot":2,"name":"Orchestration Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send_BEnrollment_File_to_Galileo"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"galileo_filename"},"2":{"slot":2,"type":"STRING","value":"${galileo_filename}"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2958545":{"id":2958545,"sourceID":2958528,"targetID":2958549},"2958550":{"id":2958550,"sourceID":2958548,"targetID":2958528}},"failureConnectors":{},"unconditionalConnectors":{"2958544":{"id":2958544,"sourceID":2958531,"targetID":2958548},"2958547":{"id":2958547,"sourceID":2958531,"targetID":2958530}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"2958529":{"id":2958529,"x":533,"y":349,"width":250,"height":58,"text":"query for populating google sheet:\n\nwith card_data as (\n    select\n        FILE_DATE,\n        row_number() over (partition by prn order by FILE_DATE desc ) as row_no,\n        prn,\n        GALILEO_ACCOUNT_ID\n    from rdl.RAW_GALILEO_ACCOUNT_CARD_DATA cd\n)\n-- select * from card_data\n-- where 1=1 and prn='223117426922'\n-- ;\nselect\n    response.FILENAME,\n    detail.EMAIL,\n    up.USER_ID,\n    response.PMT_REF_NO,\n    detail.PRODUCT_ID,\n    cd.GALILEO_ACCOUNT_ID\nfrom etl.galileo_enrollment_batch_response_jchen response\njoin etl.GALILEO_ENROLLMENT_BATCH_DETAIL_HISTORY detail\n    on response.external_id=detail.EXTERNAL_ID and detail.FILENAME=response.FILENAME\n-- left join WEB_DB.USER_EMAIL ue on ue.EMAIL=detail.EMAIL and IS_PRIMARY=true\njoin WEB_DB.USER_PROFILE up on up.FIRST_NAME=detail.PRIMARY_CARDHOLDER_FIRST_NAME\n    and up.LAST_NAME=detail.PRIMARY_CARDHOLDER_LAST_NAME\n    and replace(up.PHONE_NUMBER, '-', '')=detail.PRIMARY_PHONE_NUMBER\njoin card_data cd on cd.row_no=1 and cd.PRN=response.PMT_REF_NO\nwhere galileo_response_code = '0000'\n  and detail.FILENAME='benroll_584_20210610_001.txt'\n\nGoogle sheet:\nhttps://docs.google.com/spreadsheets/d/1kvak-Pkwpq0_mDEuCgfbl_9dlVFzAvLhAjUoXltTu8Q/edit#gid=567605794","colour":"e6e63c"},"2958534":{"id":2958534,"x":-215,"y":191,"width":250,"height":58,"text":"Query to populate history table:\ninsert into etl.GALILEO_ENROLLMENT_BATCH_DETAIL_HISTORY\n    (FILENAME, RECORD_TYPE, RECORD_NUMBER, PRODUCT_ID, PRIMARY_CARDHOLDER_FIRST_NAME, PRIMARY_CARDHOLDER_MIDDLE_NAME, PRIMARY_CARDHOLDER_LAST_NAME, ADDRESS_LINE_1, ADDRESS_LINE_2, CITY, STATE, ZIP_CODE, COUNTRY, PRIMARY_PHONE_NUMBER, SECONDARY_PHONE_NUMBER, EMAIL, ID_1_TYPE, ID_1_VALUE, ID_2_TYPE, ID_2_VALUE, DATE_OF_BIRTH, EXTERNAL_ID, EXPRESS_MAIL, LOAD_AMOUNT, LOAD_TYPE, LOAD_DESCRIPTION, HIT_ID, SOURCE, WEB_UID, WEB_PWD, SECRET_QUESTION, SECRET_ANSWER, MOBILE_PHONE_NUMBER, CARRIER_ID, EMBOSS_LINE_2)\nselect\n    'benroll_584_20210606_001.txt', record_type, record_number, product_id, primary_cardholder_first_name, primary_cardholder_middle_name, primary_cardholder_last_name, address_line_1, address_line_2, city, state, zip_code, country, primary_phone_number, secondary_phone_number, email, id_1_type, '*********', id_2_type, id_2_value, date_of_birth, external_id, express_mail, load_amount, load_type, load_description, hit_id, source, web_uid, web_pwd, secret_question, secret_answer, mobile_phone_number, carrier_id, emboss_line_2\nfrom etl.GALILEO_ENROLLMENT_BATCH_DETAIL\n;","colour":"d60000"},"2958535":{"id":2958535,"x":255,"y":-9,"width":332,"height":337,"text":"make a copy of this job for any new task\n\nChange the 2 varialbes\n- filename\n- filedate\n\nand change the user ids in the 'create galileo table' component'\n\nrun the job, the file will show up in this s3 folder:\nhttps://s3.console.aws.amazon.com/s3/buckets/aspiration-datateam?region=us-west-2&prefix=dump/jchen/galileo_snowflake/&state=hashArgs%23\n\nand then populate the history table (GALILEO_ENROLLMENT_BATCH_DETAIL_HISTORY).\n\n\nThen run this job to parse the response file to populate the response table.\nGet_BEnrollment_response_File_from_Galileo_jchen_adhoc\n\nand run query to populate the google sheet the next day when the new galileo card data file (which have the galileo_account_ids) arrives.","colour":"e6e63c"}},"variables":{"file_transmit_date":{"definition":{"name":"file_transmit_date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"06112021"},"galileo_filename":{"definition":{"name":"galileo_filename","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"benroll_584_20210611_xyz.txt"}},"grids":{}},"info":{"name":"20210611_batch_create_accounts_serena","description":"","type":"ORCHESTRATION","tag":"28589c5b-48c5-42ef-a1f2-59e6e2169b0d"}}