{"job":{"components":{"2962640":{"id":2962640,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-216,"y":17,"width":32,"height":32,"inputConnectorIDs":[2962700],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Create view"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CREATE OR REPLACE VIEW edw.view_unique_user_accounts AS\n\n  WITH\n    u_a AS (\n      SELECT DISTINCT user_id, account_id\n      FROM web_db.user_account\n      ),\n\n    u_a_one AS (\n      SELECT account_id, COUNT(*) cnt\n      FROM u_a\n      GROUP BY account_id\n      HAVING cnt = 1\n      ),\n\n    accounts_with_one_user_id AS (\n      SELECT account_id, user_id\n      FROM web_db.user_account\n      WHERE account_id IN (SELECT DISTINCT account_id FROM u_a_one)\n      ),\n\n    u_a_two AS (\n      SELECT account_id, COUNT(*) cnt\n      FROM u_a\n      GROUP BY account_id\n      HAVING cnt = 2\n      ),\n\n    primary_users AS (\n      SELECT DISTINCT acc.id AS account_id, uacc.user_id as user_id, uacc.user_account_type AS user_account_type\n      FROM aog_db.galileo_accounts aog\n             JOIN web_db.user_product_application uapp ON uapp.id = aog.aspiration_application_id AND uapp.user_id = aog.aspiration_user_id --AND uapp.product_id = 4\n             JOIN web_db.account acc ON acc.id = uapp.account_id\n             JOIN web_db.product prod ON prod.id = uapp.product_id\n             JOIN web_db.user_email ueml ON ueml.user_id = uapp.user_id\n             JOIN web_db.user_account uacc ON uacc.user_id = uapp.user_id AND uacc.account_id = uapp.account_id\n             JOIN web_db.user_payment_account upay ON upay.user_id = uacc.user_id\n             JOIN web_db.depository dep ON dep.id = upay.depository_id AND dep.account_id = uacc.account_id AND dep.product_id = uapp.product_id\n      WHERE 1=1\n        AND uapp.account_type_id = 2\n      ),\n\n    accounts_with_two_user_id_primary AS (\n      SELECT pr.account_id AS account_id, MIN(pr.user_id) as user_id\n      FROM u_a_two AS ua\n             INNER JOIN primary_users AS pr ON ua.account_id = pr.account_id\n      GROUP BY pr.account_id\n      ),\n\n    accounts_with_two_user_id_left_ids AS (\n      SELECT account_id\n      FROM u_a_two\n           EXCEPT\n      SELECT account_id\n      FROM accounts_with_two_user_id_primary\n      ),\n\n    accounts_with_two_user_id_left AS (\n      SELECT a.account_id AS account_id, MIN(ua.user_id) AS user_id\n      FROM accounts_with_two_user_id_left_ids as a\n             INNER JOIN web_db.user_account AS ua ON a.account_id = ua.account_id\n      GROUP BY a.account_id\n      )\n\n    SELECT account_id, user_id\n    FROM accounts_with_one_user_id\n    UNION\n    SELECT account_id, user_id\n    FROM accounts_with_two_user_id_primary\n    UNION\n    SELECT account_id, user_id\n    FROM accounts_with_two_user_id_left;"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2962642":{"id":2962642,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-304,"y":16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2962700],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2962643":{"id":2962643,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-48,"y":96,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"TMP"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"GRANT SELECT ON ${Pnl_schema}.${Target_table} TO \"szhang\";\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{},"failureConnectors":{},"unconditionalConnectors":{"2962700":{"id":2962700,"sourceID":2962642,"targetID":2962640}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"2962641":{"id":2962641,"x":-78,"y":57,"width":91,"height":78,"text":"for development","colour":"d60000"}},"variables":{"Pnl_schema":{"definition":{"name":"Pnl_schema","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"edw"},"Target_table":{"definition":{"name":"Target_table","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"view_unique_user_accounts"}},"grids":{}},"info":{"name":"pnl_init_view_unique_user_accounts","description":null,"type":"ORCHESTRATION","tag":"5b2292ff-817f-467b-8c5e-967766f06d3a"}}