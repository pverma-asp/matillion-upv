{"job":{"components":{"2962852":{"id":2962852,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-256,"y":-128,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DELETE FROM TABLE"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DELETE FROM ${schema_name}.${table_name}"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2962853":{"id":2962853,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":64,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2962854],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"INSERT INTO TABLE"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"INSERT INTO ${schema_name}.${table_name}(flag_processed,\n                                         first_part_start_date,\n                                         first_part_end_date,\n                                         time_payment,\n                                         second_part_start_date,\n                                         second_part_end_date,\n                                         professional_payment)\n\nVALUES (\n  FALSE,\n  TO_DATE(TO_CHAR(${first_part_start_date}, 'FM99999999'), 'YYYYMMDD'),\n  TO_DATE(TO_CHAR(${first_part_end_date}, 'FM99999999'), 'YYYYMMDD'),\n  ${time_payment},\n  TO_DATE(TO_CHAR(${second_part_start_date}, 'FM99999999'), 'YYYYMMDD'),\n  TO_DATE(TO_CHAR(${second_part_end_date}, 'FM99999999'), 'YYYYMMDD'),\n  ${professional_payment});\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2962855":{"id":2962855,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-144,"y":-128,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DROP TABLE"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DROP TABLE ${schema_name}.${table_name}"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2962856":{"id":2962856,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-240,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2962877],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2962851,2962876],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CREATE TABLE"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"CREATE TABLE IF NOT EXISTS ${schema_name}.${table_name}(id bigint identity(1, 1),\n                                                        flag_processed bool not null,\n                                                        first_part_start_date date not null,\n                                                        first_part_end_date date not null,\n                                                        time_payment numeric(38,8) not null,\n                                                        second_part_start_date date not null,\n                                                        second_part_end_date date not null,\n                                                        professional_payment numeric(38,8) not null);"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2962857":{"id":2962857,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-400,"y":-16,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2962877],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2962858":{"id":2962858,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":-80,"y":-16,"width":32,"height":32,"inputConnectorIDs":[2962876],"outputSuccessConnectorIDs":[2962854],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"parse Tymeshift txt"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport re\nimport HTMLParser\n\nid = mail_id\nquery = \"SELECT messagebody FROM edw.etl_mail WHERE id = '\" + str(id) + \"'\"\n\ncursor = context.cursor()\ncursor.execute(query)\nhtml_body = cursor.fetchone()[0]\n\nmonths = {'Jan':'01','Feb':'02','Mar':'03','Apr':'04','May':'05','Jun':'06','Jul':'07','Aug':'08','Sep':'09','Oct':'10','Nov':'11','Dec':'12'}\n\ndef parseDate(text_date):\n  lst = text_date.split(\" \")\n  date, year, month = \"\", \"\", \"\"\n  for x in lst:\n    if len(x) == 4: year += x\n    if len(x) == 3: month += months.get(x)\n    if len(x) == 2: date += x\n    if len(x) == 1: date += \"0\" + x \n  return year + month + date\n\nresult = re.findall(r'(\\w{3} \\d{1,2}, \\d{4})(.*?)(\\w{3} \\d{1,2}, \\d{4})', html_body)\nprint(result[0][0], result[0][2], result[1][0], result[1][2])\n\ncontext.updateVariable(\"first_part_start_date\", parseDate(result[0][0].replace(',','')))\ncontext.updateVariable(\"first_part_end_date\", parseDate(result[0][2].replace(',','')))\ncontext.updateVariable(\"second_part_start_date\", parseDate(result[1][0].replace(',','')))\ncontext.updateVariable(\"second_part_end_date\", parseDate(result[1][2].replace(',','')))\n\nresult = re.findall(r'(-)?\\$([0-9,\\.]*)', html_body)\ntime_total = 0\nlst = result[1:-2]\nfor item in lst:\n  if item[0] == '-': time_total -= float(item[1].replace(',',''))\n  else: time_total += float(item[1].replace(',',''))\ncontext.updateVariable(\"time_payment\", time_total)\n\nprof_total = 0\nif result[-2][0] == '-': prof_total -= float(result[-2][1].replace(',',''))\nelse: prof_total += float(result[-2][1].replace(',',''))\ncontext.updateVariable(\"professional_payment\", prof_total)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Jython"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2962859":{"id":2962859,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-80,"y":96,"width":32,"height":32,"inputConnectorIDs":[2962851],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Grant Select access to created table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"GRANT SELECT ON edw.${table_name} TO \"spashchenko.ctr\";\nGRANT SELECT ON edw.${table_name} TO \"ashumakov.ctr\";\nGRANT SELECT ON edw.${table_name} TO \"vfigurkin.ctr\";\nGRANT SELECT ON edw.${table_name} TO \"opetrova.ctr\";\nGRANT SELECT ON edw.${table_name} TO \"idudkin.ctr\";\nGRANT SELECT ON edw.${table_name} TO \"spashchenko.ctr\";"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2962854":{"id":2962854,"sourceID":2962858,"targetID":2962853}},"failureConnectors":{},"unconditionalConnectors":{"2962851":{"id":2962851,"sourceID":2962856,"targetID":2962859},"2962876":{"id":2962876,"sourceID":2962856,"targetID":2962858},"2962877":{"id":2962877,"sourceID":2962857,"targetID":2962856}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"2962862":{"id":2962862,"x":-338,"y":-152,"width":250,"height":58,"text":"dev","colour":"d60000"}},"variables":{"first_part_end_date":{"definition":{"name":"first_part_end_date","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""},"first_part_start_date":{"definition":{"name":"first_part_start_date","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""},"mail_id":{"definition":{"name":"mail_id","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""},"professional_payment":{"definition":{"name":"professional_payment","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""},"s3_bucket":{"definition":{"name":"s3_bucket","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"aspiration-pnl-project-staging"},"s3_file_name":{"definition":{"name":"s3_file_name","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"talkdesk_invoice.txt"},"schema_name":{"definition":{"name":"schema_name","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"edw"},"second_part_end_date":{"definition":{"name":"second_part_end_date","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""},"second_part_start_date":{"definition":{"name":"second_part_start_date","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""},"table_name":{"definition":{"name":"table_name","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"etl_call_center_tymeshift"},"time_payment":{"definition":{"name":"time_payment","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"pnl_etl_tymeshift_txt_to_table","description":"","type":"ORCHESTRATION","tag":"e2366b5c-5f78-4713-8deb-70e43b501c65"}}