{"job":{"components":{"2968481":{"id":2968481,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-112,"y":112,"width":32,"height":32,"inputConnectorIDs":[2968500],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Copy of insert to history"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"insert into etl.GALILEO_ENROLLMENT_BATCH_DETAIL_HISTORY\n    (FILENAME, RECORD_TYPE, RECORD_NUMBER, PRODUCT_ID, PRIMARY_CARDHOLDER_FIRST_NAME, PRIMARY_CARDHOLDER_MIDDLE_NAME, PRIMARY_CARDHOLDER_LAST_NAME, ADDRESS_LINE_1, ADDRESS_LINE_2, CITY, STATE, ZIP_CODE, COUNTRY, PRIMARY_PHONE_NUMBER, SECONDARY_PHONE_NUMBER, EMAIL, ID_1_TYPE, ID_1_VALUE, ID_2_TYPE, ID_2_VALUE, DATE_OF_BIRTH, EXTERNAL_ID, EXPRESS_MAIL, LOAD_AMOUNT, LOAD_TYPE, LOAD_DESCRIPTION, HIT_ID, SOURCE, WEB_UID, WEB_PWD, SECRET_QUESTION, SECRET_ANSWER, MOBILE_PHONE_NUMBER, CARRIER_ID, EMBOSS_LINE_2)\nselect\n    '${galileo_filename}', record_type, record_number, product_id, primary_cardholder_first_name, primary_cardholder_middle_name, primary_cardholder_last_name, address_line_1, address_line_2, city, state, zip_code, country, primary_phone_number, secondary_phone_number, email, id_1_type, '*********', id_2_type, id_2_value, date_of_birth, external_id, express_mail, load_amount, load_type, load_description, hit_id, source, web_uid, web_pwd, secret_question, secret_answer, mobile_phone_number, carrier_id, emboss_line_2\nfrom etl.GALILEO_ENROLLMENT_BATCH_DETAIL\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968484":{"id":2968484,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2968482,2968500],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968485":{"id":2968485,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":128,"y":64,"width":32,"height":32,"inputConnectorIDs":[2968482],"outputSuccessConnectorIDs":[2968480],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"not used"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"update\n etl.GALILEO_ENROLLMENT_BATCH_DETAIL_HISTORY\n set filename='benroll_584_20210610_001.txt'\nwhere 1=1\n  and FILENAME='benroll_584_20210610_001.txt.txt'\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968486":{"id":2968486,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":160,"y":176,"width":32,"height":32,"inputConnectorIDs":[2968480],"outputSuccessConnectorIDs":[2968483],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create galileo enrollment table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"UPDATE etl.galileo_enrollment_batch_header\nSET file_name = '${galileo_filename}.gpg',\n       file_transmit_date = '${file_transmit_date}'\nWHERE record_type = 'H'\n;\n\ndelete from etl.galileo_enrollment_batch_detail;\ninsert into ETL.GALILEO_ENROLLMENT_BATCH_DETAIL\n    (RECORD_TYPE, RECORD_NUMBER, PRODUCT_ID, PRIMARY_CARDHOLDER_FIRST_NAME, PRIMARY_CARDHOLDER_MIDDLE_NAME, PRIMARY_CARDHOLDER_LAST_NAME, ADDRESS_LINE_1, ADDRESS_LINE_2, CITY, STATE, ZIP_CODE, COUNTRY, PRIMARY_PHONE_NUMBER, SECONDARY_PHONE_NUMBER, EMAIL, ID_1_TYPE, ID_1_VALUE, ID_2_TYPE, ID_2_VALUE, DATE_OF_BIRTH, EXTERNAL_ID, EXPRESS_MAIL, LOAD_AMOUNT, LOAD_TYPE, LOAD_DESCRIPTION, HIT_ID, SOURCE, WEB_UID, WEB_PWD, SECRET_QUESTION, SECRET_ANSWER, MOBILE_PHONE_NUMBER, CARRIER_ID, EMBOSS_LINE_2)\n\nwith aplus_users as (\n    select ua.USER_ID\n--     distinct PLAN_ID\n    from WEB_DB.SUBSCRIPTION s\n             join WEB_DB.USER_ACCOUNT ua on s.ACCOUNT_ID = ua.ACCOUNT_ID\n    where 1 = 1\n      and plan_id ILIKE 'planet%protection%'\n      and status = 'active'\n)\n, pids as (\nselect\n    da.USER_ID,\n    da.INCEPTION_DATE::date as inception_date,\n    datediff('day', da.INCEPTION_DATE, current_date()) as days_since_inception,\n    ap.USER_ID is not null as is_aplus_user,\n    case\n        when ap.USER_ID is null and days_since_inception < 30 then 6540     -- non aplus\n        when ap.USER_ID is null and days_since_inception >=30 then 6635     -- non aplus\n        when ap.USER_ID is not null and days_since_inception < 30 then 6541 -- aplus\n        when ap.USER_ID is not null and days_since_inception >=30 then 6542 -- aplus\n    end as pid\nfrom bi.DT_ACCOUNTS da\n-- join etl.ATO_USERS_LIST_20210602 atou on da.USER_ID=atou.USER_ID\nleft join aplus_users ap on da.USER_ID=ap.USER_ID\nwhere 1=1\n  and ACCOUNT_TYPE='Checking'\n  and TERMINATION_DATE is null\n)\nselect\n--     pids.USER_ID,\n--     ue.EMAIL,\n    'D' as record_type\n    ,row_number() over (order by ue.USER_ID) as recordnumber\n    ,pids.pid::varchar as product_id\n    ,left(up.FIRST_NAME, 20)\n    ,left(COALESCE(up.MIDDLE_NAME, ''), 20)  -- can be null\n    ,left(up.LAST_NAME, 20)\n    ,left(a.STREET1, 30)\n    ,COALESCE(a.street2, '')  -- can be null\n    ,left(a.CITY, 20)\n    ,s.CODE\n    ,replace(a.ZIP_OR_POSTAL_CODE, '-', '')\n    ,'USA' as country\n    ,replace(up.PHONE_NUMBER, '-', '')\n    ,'' -- secondary phone number\n    ,ue.EMAIL\n    ,'2' -- ID 1 type\n    ,upsin.TAX_IDENTIFICATION_NUMBER -- sin number\n    ,'' -- ID 2 type\n    ,''\n    ,to_char(up.DATE_OF_BIRTH, 'MM/DD/YYYY')  -- date of birth\n    ,to_char(current_date(), 'YYYYMMDD') || '_' || to_char(current_time(), 'HH24MISS') || '_' || lpad(recordnumber, 6, '0') -- external id\n    ,case when pids.pid in (6541, 6542) then 'Y' else 'N' end  -- express mail\n    ,''  -- load amount\n    ,''  -- load type\n    ,''  -- load desc\n    ,''  -- hit id\n    ,''  -- source\n    ,''  -- web uid\n    ,''  -- web pwd\n    ,''  -- secret q\n    ,''  -- secret a\n    ,''  -- mobile phone\n    ,''  -- carrier id\n    ,''  -- emboss line 2\nfrom pids\njoin WEB_DB.user_profile up on pids.USER_ID=up.USER_ID\njoin WEB_DB.USER_EMAIL ue on up.USER_ID=ue.USER_ID and ue.IS_PRIMARY = true\njoin WEB_DB.ADDRESS a on up.ADDRESS_ID=a.id\njoin WEB_DB.STATE s on a.STATE_ID=s.ID\njoin PCI_STG.USER_PROFILE upsin on upsin.USER_ID=up.USER_ID\nwhere 1=1\n  and ue.user_id in (\n143982\n,3255948\n,4021938\n,56113\n,548836\n,93246\n,212907\n,221498\n,384563\n,47069\n,502319\n,258761\n,1406102\n,281126\n,180594\n,2241730\n,536949\n,1292875\n,153500\n,223899\n,3002640\n,733819\n,2464285\n,2851276\n,3390916\n,4117777\n,122396\n,228839\n,654776\n,510391\n,488480\n,344758\n,2965956\n,414334\n,1598370\n,4040584\n,1416915\n,168968\n,2277674\n,2299785\n,3424853\n,345874\n,1744945\n,1689933\n,1523566\n,128150\n,699875\n,2867609\n,253616\n,103409\n,758179\n,305526\n,62718\n,130476\n,1840571\n,105595\n,232164\n,949349\n,588617\n,137057\n,342878\n,176400\n,471263\n,626356\n,2117604\n,590231\n,3860556\n,1436908\n,1048422\n,1534123\n,311639\n,2005180\n,1207264\n,870872\n,347275\n,2602887\n,2237324\n,3072525\n,153725\n,3007231\n,4124409\n,4069926\n,351953\n,90624\n,1276725\n,318920\n,313143\n,363900\n,3323321\n,32039\n,697238\n,115466\n,167524\n,178004\n,313235\n,357117\n,1666453\n,1837039\n,1933534\n,2073005\n,535734\n,709499\n,1306630\n,145919\n,340310\n,365748\n,321269\n,1519191\n,301115\n,798804\n,1780531\n,366531\n,272341\n,85786\n,476967\n,1787880\n,1577221\n,3788654\n,348717\n,172686\n,624445\n,962081\n,3199310\n,1885220\n,1541266\n,962841\n,1043566\n,1011006\n,422987\n,702270\n,931144\n,1042447\n,1458431\n,89952\n,189276\n,1487607\n,3554181\n,690835\n,2915754\n,166427\n,438566\n,673195\n,972188\n,1108912\n,1394232\n,369714\n,382398\n,989241\n,1066724\n,437176\n,563537\n,1226593\n,165462\n,590315\n,74799\n,147725\n,579541\n,213119\n,924338\n,808948\n,66925\n,10168\n,238068\n,37592\n,216704\n,153394\n,154532\n,219401\n,579301\n,359306\n,1142273\n,1182493\n,1262478\n,1794204\n,1686232\n,3620997\n\n    )\n;\n\n\n--trailer data\nUPDATE etl.galileo_enrollment_batch_trailer\n   SET \"count\" = (select count(*) from etl.galileo_enrollment_batch_detail)\nWHERE record_type = 'T';\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968487":{"id":2968487,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1785813072,"x":160,"y":288,"width":32,"height":32,"inputConnectorIDs":[2968483],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send_BEnrollment_File_to_Galileo 0"}}}},"visible":true},"2":{"slot":2,"name":"Orchestration Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send_BEnrollment_File_to_Galileo"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"galileo_filename"},"2":{"slot":2,"type":"STRING","value":"${galileo_filename}"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2968480":{"id":2968480,"sourceID":2968485,"targetID":2968486},"2968483":{"id":2968483,"sourceID":2968486,"targetID":2968487}},"failureConnectors":{},"unconditionalConnectors":{"2968482":{"id":2968482,"sourceID":2968484,"targetID":2968485},"2968500":{"id":2968500,"sourceID":2968484,"targetID":2968481}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"2968490":{"id":2968490,"x":255,"y":-9,"width":332,"height":337,"text":"make a copy of this job for any new task\n\nChange the 2 varialbes\n- filename\n- filedate\n\nand change the user ids in the 'create galileo table' component'\n\nrun the job, the file will show up in this s3 folder:\n\n\nand then populate the history table (GALILEO_ENROLLMENT_BATCH_DETAIL_HISTORY).\nhttps://s3.console.aws.amazon.com/s3/buckets/aspiration-datateam?region=us-west-2&prefix=dump/jchen/galileo_snowflake/&state=hashArgs%23\n\nThen run this job to parse the response file to populate the response table.\nGet_BEnrollment_response_File_from_Galileo_jchen_adhoc\n\nand run query to populate the google sheet the next day when the new galileo card data file (which have the galileo_account_ids) arrives.","colour":"e6e63c"}},"variables":{"file_transmit_date":{"definition":{"name":"file_transmit_date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"06102021"},"galileo_filename":{"definition":{"name":"galileo_filename","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"benroll_584_20210610_001.txt"}},"grids":{}},"info":{"name":"20210610_batch_create_accounts","description":"","type":"ORCHESTRATION","tag":"5c80d7f1-2312-4665-a5b2-39bfe156c04e"}}