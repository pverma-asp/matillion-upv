{"job":{"components":{"2968404":{"id":2968404,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":128,"y":64,"width":32,"height":32,"inputConnectorIDs":[2968401],"outputSuccessConnectorIDs":[2968407],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"not used"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"DROP TABLE if exists etl.ato_users_list_20210602;\n\nCREATE TABLE if not exists etl.ato_users_list_20210602 (\n  user_id number(20),\n  upgrade_to_aplus varchar(200)\n)\n;\n\ncopy into etl.ato_users_list_20210602\n\tfrom @public.datateam/dump/jchen/promotions/ato_users_list_20210602.csv\nfile_format = (type ='CSV'\n    field_DELIMITER = ','\n    ESCAPE = '\\\\'\n    SKIP_HEADER = 1\n    )\n;\n\n\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968405":{"id":2968405,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1785813072,"x":160,"y":288,"width":32,"height":32,"inputConnectorIDs":[2968406],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send_BEnrollment_File_to_Galileo 0"}}}},"visible":true},"2":{"slot":2,"name":"Orchestration Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Send_BEnrollment_File_to_Galileo"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"galileo_filename"},"2":{"slot":2,"type":"STRING","value":"${galileo_filename}"}}}},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968410":{"id":2968410,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2968401],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968411":{"id":2968411,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":160,"y":176,"width":32,"height":32,"inputConnectorIDs":[2968407],"outputSuccessConnectorIDs":[2968406],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create galileo enrollment table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"UPDATE etl.galileo_enrollment_batch_header\nSET file_name = '${galileo_filename}.gpg',\n       file_transmit_date = '${file_transmit_date}'\nWHERE record_type = 'H'\n;\n\ndelete from etl.galileo_enrollment_batch_detail;\ninsert into ETL.GALILEO_ENROLLMENT_BATCH_DETAIL\n    (RECORD_TYPE, RECORD_NUMBER, PRODUCT_ID, PRIMARY_CARDHOLDER_FIRST_NAME, PRIMARY_CARDHOLDER_MIDDLE_NAME, PRIMARY_CARDHOLDER_LAST_NAME, ADDRESS_LINE_1, ADDRESS_LINE_2, CITY, STATE, ZIP_CODE, COUNTRY, PRIMARY_PHONE_NUMBER, SECONDARY_PHONE_NUMBER, EMAIL, ID_1_TYPE, ID_1_VALUE, ID_2_TYPE, ID_2_VALUE, DATE_OF_BIRTH, EXTERNAL_ID, EXPRESS_MAIL, LOAD_AMOUNT, LOAD_TYPE, LOAD_DESCRIPTION, HIT_ID, SOURCE, WEB_UID, WEB_PWD, SECRET_QUESTION, SECRET_ANSWER, MOBILE_PHONE_NUMBER, CARRIER_ID, EMBOSS_LINE_2)\n\nwith aplus_users as (\n    select ua.USER_ID\n--     distinct PLAN_ID\n    from WEB_DB.SUBSCRIPTION s\n             join WEB_DB.USER_ACCOUNT ua on s.ACCOUNT_ID = ua.ACCOUNT_ID\n    where 1 = 1\n      and plan_id ILIKE 'planet%protection%'\n      and status = 'active'\n)\n, pids as (\nselect\n    da.USER_ID,\n    da.INCEPTION_DATE::date as inception_date,\n    datediff('day', da.INCEPTION_DATE, current_date()) as days_since_inception,\n    ap.USER_ID is not null as is_aplus_user,\n    case\n        when ap.USER_ID is null and days_since_inception < 30 then 6540     -- non aplus\n        when ap.USER_ID is null and days_since_inception >=30 then 6635     -- non aplus\n        when ap.USER_ID is not null and days_since_inception < 30 then 6541 -- aplus\n        when ap.USER_ID is not null and days_since_inception >=30 then 6542 -- aplus\n    end as pid\nfrom bi.DT_ACCOUNTS da\n-- join etl.ATO_USERS_LIST_20210602 atou on da.USER_ID=atou.USER_ID\nleft join aplus_users ap on da.USER_ID=ap.USER_ID\nwhere 1=1\n  and ACCOUNT_TYPE='Checking'\n)\nselect\n--     pids.USER_ID,\n--     ue.EMAIL,\n    'D' as record_type\n    ,row_number() over (order by ue.USER_ID) as recordnumber\n    ,pids.pid::varchar as product_id\n    ,left(up.FIRST_NAME, 20)\n    ,left(COALESCE(up.MIDDLE_NAME, ''), 20)  -- can be null\n    ,left(up.LAST_NAME, 20)\n    ,left(a.STREET1, 30)\n    ,COALESCE(a.street2, '')  -- can be null\n    ,left(a.CITY, 20)\n    ,s.CODE\n    ,replace(a.ZIP_OR_POSTAL_CODE, '-', '')\n    ,'USA' as country\n    ,replace(up.PHONE_NUMBER, '-', '')\n    ,'' -- secondary phone number\n    ,ue.EMAIL\n    ,'2' -- ID 1 type\n    ,upsin.TAX_IDENTIFICATION_NUMBER -- sin number\n    ,'' -- ID 2 type\n    ,''\n    ,to_char(up.DATE_OF_BIRTH, 'MM/DD/YYYY')  -- date of birth\n    ,to_char(current_date(), 'YYYYMMDD') || '_' || to_char(current_time(), 'HH24MISS') || '_' || lpad(recordnumber, 6, '0') -- external id\n    ,case when pids.pid in (6541, 6542) then 'Y' else 'N' end  -- express mail\n    ,''  -- load amount\n    ,''  -- load type\n    ,''  -- load desc\n    ,''  -- hit id\n    ,''  -- source\n    ,''  -- web uid\n    ,''  -- web pwd\n    ,''  -- secret q\n    ,''  -- secret a\n    ,''  -- mobile phone\n    ,''  -- carrier id\n    ,''  -- emboss line 2\nfrom pids\njoin WEB_DB.user_profile up on pids.USER_ID=up.USER_ID\njoin WEB_DB.USER_EMAIL ue on up.USER_ID=ue.USER_ID and ue.IS_PRIMARY = true\njoin WEB_DB.ADDRESS a on up.ADDRESS_ID=a.id\njoin WEB_DB.STATE s on a.STATE_ID=s.ID\njoin PCI_STG.USER_PROFILE upsin on upsin.USER_ID=up.USER_ID\nwhere 1=1\n  and ue.user_id in (\n-- 554291 -- nima\n 2594789\n,3031901\n,3123683\n,3132021\n,3637112\n,1671328\n,34634\n,1633116\n,3535208\n,2524417\n,586946\n,476984\n,2558995\n,1120950\n,3549929\n,2250336\n,1663121\n,649972\n,642776\n,1622982\n,3287816\n,3647781\n,2788939\n,1223733\n,1612190\n,172690\n,2080898\n,3496095\n,1058932\n,1638970\n,3102331\n,1638703\n,1610626\n,3395724\n,3480031\n,3315405\n,4131444\n,3900061\n,789652\n,1711594\n,778266\n    )\n;\n\n\n--trailer data\nUPDATE etl.galileo_enrollment_batch_trailer\n   SET \"count\" = (select count(*) from etl.galileo_enrollment_batch_detail)\nWHERE record_type = 'T';\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2968406":{"id":2968406,"sourceID":2968411,"targetID":2968405},"2968407":{"id":2968407,"sourceID":2968404,"targetID":2968411}},"failureConnectors":{},"unconditionalConnectors":{"2968401":{"id":2968401,"sourceID":2968410,"targetID":2968404}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"2968408":{"id":2968408,"x":-186,"y":123,"width":240,"height":128,"text":"Change the 2 varialbes\n- filename\n- filedate\n\nand change the user ids in the 'create galileo table' component'","colour":"e6e63c"}},"variables":{"file_transmit_date":{"definition":{"name":"file_transmit_date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"06062021"},"galileo_filename":{"definition":{"name":"galileo_filename","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"benroll_584_20210606_001.txt"}},"grids":{}},"info":{"name":"20210604_batch_create_accounts_invalid_addresses","description":"","type":"ORCHESTRATION","tag":"dba5ecf1-d635-414b-af2a-af7cda5d4927"}}