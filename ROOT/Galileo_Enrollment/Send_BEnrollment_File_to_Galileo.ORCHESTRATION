{"job":{"components":{"2968320":{"id":2968320,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":-224,"y":96,"width":32,"height":32,"inputConnectorIDs":[2968344],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"create table script"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"copy into etl.GALILEO_ENROLLMENT_BATCH_HEADER\n    from @public.datateam/dump/jchen/zendesk_dump/galileo_enrollment_file/galileo_enrollment_batch_header000\nfile_format = (type ='CSV'\n    field_DELIMITER = ','\n    ESCAPE = '\\\\'\n    )\n;\n\n\ncopy into etl.GALILEO_ENROLLMENT_BATCH_TRAILER\n    from @public.datateam/dump/jchen/zendesk_dump/galileo_enrollment_file/galileo_enrollment_batch_trailer000\nfile_format = (type ='CSV'\n    field_DELIMITER = ','\n    ESCAPE = '\\\\'\n    )\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"DISABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968322":{"id":2968322,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":0,"y":80,"width":32,"height":32,"inputConnectorIDs":[2968345],"outputSuccessConnectorIDs":[2968350],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"encrypt_file"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\n#python function to call lambda to encrypt s3 file to send to galileo\nimport time\n\nbody = json.dumps(dict(operation='enc',file='s3://aspiration-datateam/dump/jchen/galileo_snowflake/${galileo_filename}',\n                       encrypted_file_path='s3://aspiration-datateam/dump/jchen/galileo_snowflake',\n                       gpg_key='galileo_public_key',\n                       extension='gpg'\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:prod-python-encrypt-decrypt-manual',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n\n\nprint ('encrypt file:', 's3://aspiration-datateam/dump/jchen/galileo_snowflake/${galileo_filename}')\nrun_lambda()\n\nprint ('wait 30 seconds for gpg file generation')\ntime.sleep(30)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968323":{"id":2968323,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[2968347],"outputSuccessConnectorIDs":[2968345],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Create galileo file"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"drop table if exists etl.galileo_file_temp_jchen;\ncreate table etl.galileo_file_temp_jchen (\n  row_no BIGINT,\n  \"row\"    varchar(20000)\n)\n;\n\ninsert into etl.galileo_file_temp_jchen (row_no, \"row\")\nselect\n  0,\n  record_type ||\n  header ||\n  rpad(client_id, 10, ' ') ||\n  rpad((file_name), 50, ' ') ||\n  file_transmit_date\nfrom etl.galileo_enrollment_batch_header\n;\n\n\ninsert into etl.galileo_file_temp_jchen (row_no, \"row\")\nselect record_number::BIGINT,\n    'D' ||\n    rpad(record_number, 6, ' ') ||\n    rpad(PRODUCT_ID, 6, ' ') ||\n    rpad(PRIMARY_CARDHOLDER_FIRST_NAME, 20, ' ') ||\n    rpad(PRIMARY_CARDHOLDER_MIDDLE_NAME, 20, ' ') ||\n    rpad(PRIMARY_CARDHOLDER_LAST_NAME, 20, ' ') ||\n    rpad(ADDRESS_LINE_1, 30, ' ') ||\n    rpad(ADDRESS_LINE_2, 30, ' ') ||\n    rpad(CITY, 20, ' ') ||\n    rpad(STATE, 2, ' ') ||\n    rpad(ZIP_CODE, 9, ' ') ||\n    rpad(COUNTRY, 3, ' ') ||\n    rpad(PRIMARY_PHONE_NUMBER, 10, ' ') ||\n    rpad(SECONDARY_PHONE_NUMBER, 10, ' ') ||\n    rpad(EMAIL, 50, ' ') ||\n    rpad(ID_1_Type, 2, ' ') ||\n    rpad(ID_1_Value, 50, ' ') ||\n    rpad(ID_2_Type, 2, ' ') ||\n    rpad(ID_2_Value, 50, ' ') ||\n    rpad(DATE_OF_BIRTH, 10, ' ') ||\n    rpad(External_ID, 30, ' ') ||\n    rpad(Express_Mail, 1, ' ') ||\n    rpad(LOAD_AMOUNT, 13, ' ') ||\n    rpad(LOAD_TYPE, 2, ' ') ||\n    rpad(LOAD_DESCRIPTION, 40, ' ') ||\n    rpad(HIT_ID, 50, ' ') ||\n    rpad(SOURCE, 10, ' ') ||\n    rpad(WEB_UID, 50, ' ') ||\n    rpad(WEB_PWD, 20, ' ') ||\n    rpad(SECRET_QUESTION, 50, ' ') ||\n    rpad(SECRET_ANSWER, 50, ' ') ||\n    rpad(MOBILE_PHONE_NUMBER, 10, ' ') ||\n    rpad(CARRIER_ID, 6, ' ') ||\n    rpad(EMBOSS_LINE_2, 28, ' ')\nfrom etl.galileo_enrollment_batch_detail\n;\n\ninsert into etl.galileo_file_temp_jchen (row_no, \"row\")\nselect 10000000,\n       record_type ||\n       trailer || rpad(count, 6,' ')\nfrom etl.galileo_enrollment_batch_trailer\n;\n\ncreate or replace file format GALILEO_BATCH_FILE_FORMAT \n  type = 'CSV'\n  field_delimiter = ',,,,,,,,'\n  comment = 'CSV format for galileo files'\n;\n\ncopy into @public.DATATEAM/dump/jchen/galileo_snowflake/${galileo_filename}\nfrom (\n\tSELECT \"row\" FROM etl.galileo_file_temp_jchen ORDER BY row_no\n)\nfile_format = (format_name = GALILEO_BATCH_FILE_FORMAT, compression = NONE)\nSINGLE=true\nmax_file_size=4900000000\n;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968348":{"id":2968348,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":0,"y":160,"width":32,"height":32,"inputConnectorIDs":[2968350],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"send_file_to_galileo"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport time\n#python function to call lambda to send encrypted file to galileo\n\n\nbody = json.dumps(dict(operation='put',working_dir='/sftpdir/batch',\n                       s3_output='s3://aspiration-datateam/dump/jchen/galileo_snowflake/${galileo_filename}.gpg',\n                       sftp_file_name='${galileo_filename}.gpg',\n                       lambda_arn='None'\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:sftp-to-s3-python',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n\nprint ('send file to galileo:', 's3://aspiration-datateam/dump/jchen/galileo_snowflake/${galileo_filename}')\nrun_lambda()\n\nprint ('wait 30 seconds for lambda function completion')\ntime.sleep(30)"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2968349":{"id":2968349,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-200,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2968344,2968347],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2968345":{"id":2968345,"sourceID":2968323,"targetID":2968322},"2968350":{"id":2968350,"sourceID":2968322,"targetID":2968348}},"failureConnectors":{},"unconditionalConnectors":{"2968344":{"id":2968344,"sourceID":2968349,"targetID":2968320},"2968347":{"id":2968347,"sourceID":2968349,"targetID":2968323}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{},"variables":{"galileo_filename":{"definition":{"name":"galileo_filename","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"benroll_584_20210611_xyz.txt"}},"grids":{}},"info":{"name":"Send_BEnrollment_File_to_Galileo","description":"","type":"ORCHESTRATION","tag":"52732d84-b681-42d7-b560-9673177f9ec5"}}