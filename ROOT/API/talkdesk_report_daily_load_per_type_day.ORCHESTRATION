{"job":{"components":{"2967732":{"id":2967732,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":352,"y":-3,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"check talkdesk report"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport botocore\nimport time\n\ns3 = boto3.resource('s3')\ns3_bucket_name = 'aspiration-datateam'\ns3_file_key = 'api/talkdesk/${report_type}/${report_type}_report_${file_date}.json'.replace('-', '')\ns3_filename = 's3://' + s3_bucket_name + '/' + s3_file_key\n#s3_filename = 's3://aspiration-datateam/api/talkdesk/${report_type}/calls_report_${file_date}.json'\n\n\nprint ('wait 60 seconds for report download...')\ntime.sleep(60)\n\n# check file existance\ntry:\n    s3.Object(s3_bucket_name, s3_file_key).load()\nexcept botocore.exceptions.ClientError as e:\n    if e.response['Error']['Code'] == \"404\":\n        # The object does not exist.\n        print ('Error downloading talkdesk report, file not exists: ', s3_filename)\n        raise e\n    else:\n        # Something else has gone wrong.\n        print ('Error downloading talkdesk report: ', s3_filename)\n        raise e\nelse:\n    # The object does exist.\n    print ('successfully downloaded talkdesk report: ', s3_filename)\n    \n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[2967708]},"2967733":{"id":2967733,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"ITERATE","implementationID":-158614544,"x":352,"y":-3,"width":32,"height":16,"inputConnectorIDs":[2967728],"outputSuccessConnectorIDs":[2967734],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Retry - check if report download finished"}}}},"visible":true},"2":{"slot":2,"name":"Number of Retries","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"10"}}}},"visible":true},"3":{"slot":3,"name":"Retry Delay","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Long delay"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[2967708],"inputIterationConnectorIDs":[]},"2967736":{"id":2967736,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1032749985,"x":320,"y":192,"width":32,"height":32,"inputConnectorIDs":[2967735],"outputSuccessConnectorIDs":[2967729],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Query record count"}}}},"visible":true},"2":{"slot":2,"name":"SQL Query","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"select\n    count(1) as cnt\nfrom api.talkdesk_${report_type}\nwhere 1=1\n--  and FILE_DATE='${file_date}'\n  and FILE_DATE > dateadd('day', -7, '${file_date}')\n"}}}},"visible":true},"3":{"slot":3,"name":"Scalar Variable Mapping","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"record_count"},"2":{"slot":2,"type":"STRING","value":"CNT"}}}},"visible":true},"4":{"slot":4,"name":"Database","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"5":{"slot":5,"name":"Target Table","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false},"6":{"slot":6,"name":"Table Columns","elements":{},"visible":false},"7":{"slot":7,"name":"Schema","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"[Environment Default]"}}}},"visible":false},"10":{"slot":10,"name":"Limit","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"100"}}}},"visible":false},"11":{"slot":11,"name":"Order By","elements":{},"visible":false},"12":{"slot":12,"name":"Sort","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Ascending"}}}},"visible":false},"13":{"slot":13,"name":"Filter Conditions","elements":{},"visible":false},"14":{"slot":14,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"AND"}}}},"visible":false},"20":{"slot":20,"name":"Basic / Advanced","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Advanced"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967737":{"id":2967737,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":160,"y":192,"width":32,"height":32,"inputConnectorIDs":[2967731],"outputSuccessConnectorIDs":[2967735],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"parse report json"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"delete from api.talkdesk_${report_type}\nwhere FILE_DATE='${file_date}'\n;\n\ncall ADW.api.parse_talkdesk_${report_type}('${file_date}');"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967738":{"id":2967738,"inputCardinality":"ONE","outputCardinality":"ZERO","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":515156205,"x":464,"y":304,"width":32,"height":32,"inputConnectorIDs":[2967730],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"End Failure - zero records loaded"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967739":{"id":2967739,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"CONDITIONAL","executionHint":"FLOW","implementationID":-1357378929,"x":320,"y":304,"width":32,"height":32,"inputConnectorIDs":[2967729],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[2967730],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"If record count > 0"}}}},"visible":true},"2":{"slot":2,"name":"Mode","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Simple"}}}},"visible":true},"3":{"slot":3,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"record_count"},"2":{"slot":2,"type":"STRING","value":"Is"},"3":{"slot":3,"type":"STRING","value":"Greater than"},"4":{"slot":4,"type":"STRING","value":"0"}}}},"visible":true},"4":{"slot":4,"name":"Combine Conditions","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"And"}}}},"visible":true},"5":{"slot":5,"name":"Condition","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":""}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967740":{"id":2967740,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186960,"x":160,"y":0,"width":32,"height":32,"inputConnectorIDs":[2967709],"outputSuccessConnectorIDs":[2967728],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"download talkdesk report"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import boto3\nimport botocore\nimport time\n\ns3 = boto3.resource('s3')\ns3_bucket_name = 'aspiration-datateam'\ns3_file_key = 'api/talkdesk/${report_type}/${report_type}_report_${file_date}.json'.replace('-', '')\ns3_filename = 's3://' + s3_bucket_name + '/' + s3_file_key\n#s3_filename = 's3://aspiration-datateam/api/talkdesk/${report_type}/calls_report_${file_date}.json'\n\nbody = json.dumps(dict(report_type='${report_type}',\n                       date='${file_date}'.replace('-', ''),\n                       file_name=s3_filename\n                      ))\n\ndef run_lambda():\n    client = boto3.client('lambda', region_name='us-west-2')\n    response = client.invoke(\n    FunctionName='arn:aws:lambda:us-west-2:332894900161:function:DEV-1498_DataTeam-TalkDesk',\n    InvocationType='Event',\n    LogType='Tail',\n    Payload=body\n    )\n\n\nprint ('download talkdesk report:', '${report_type}', '${file_date}')\nrun_lambda()\n\n#print ('wait 30 seconds for report download...')\n#time.sleep(30)\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967742":{"id":2967742,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-798585337,"x":160,"y":96,"width":32,"height":32,"inputConnectorIDs":[2967734],"outputSuccessConnectorIDs":[2967731],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"refresh external table"}}}},"visible":true},"2":{"slot":2,"name":"SQL Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"alter external table adw.api.stg_talkdesk_${report_type} refresh;\n"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"2967743":{"id":2967743,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":0,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[2967709],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"2967728":{"id":2967728,"sourceID":2967740,"targetID":2967733},"2967729":{"id":2967729,"sourceID":2967736,"targetID":2967739},"2967731":{"id":2967731,"sourceID":2967742,"targetID":2967737},"2967734":{"id":2967734,"sourceID":2967733,"targetID":2967742},"2967735":{"id":2967735,"sourceID":2967737,"targetID":2967736}},"failureConnectors":{},"unconditionalConnectors":{"2967709":{"id":2967709,"sourceID":2967743,"targetID":2967740}},"trueConnectors":{},"falseConnectors":{"2967730":{"id":2967730,"sourceID":2967739,"targetID":2967738}},"iterationConnectors":{"2967708":{"id":2967708,"sourceID":2967733,"targetID":2967732}},"noteConnectors":{},"notes":{},"variables":{"file_date":{"definition":{"name":"file_date","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"2021-11-12"},"record_count":{"definition":{"name":"record_count","type":"DECIMAL","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"0"},"report_type":{"definition":{"name":"report_type","type":"TEXT","scope":"TASKBATCH","description":"","visibility":"PUBLIC"},"value":"ring_attempts"}},"grids":{}},"info":{"name":"talkdesk_report_daily_load_per_type_day","description":"","type":"ORCHESTRATION","tag":"5e6a4973-8edf-417d-a404-3d665911322f"}}